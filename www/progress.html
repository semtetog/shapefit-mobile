<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script src="./www-config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Progresso - ShapeFIT</title>
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- √çcones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- CSS -->
    <link rel="stylesheet" href="./assets/css/style.css">
    
    <script>
        // BASE_APP_URL j√° foi definido pelo www-config.js
        if (!window.BASE_APP_URL) { window.BASE_APP_URL = window.location.origin + window.location.pathname.split('/').slice(0, -1).join('/'); } if (window.BASE_APP_URL && window.BASE_APP_URL.endsWith('/')) {
            window.BASE_APP_URL = window.BASE_APP_URL.slice(0, -1);
        }
    </script>
    
    <style>
        /* Layout principal */
        .progress-page-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px 8px 40px 8px;
        }

        .page-header {
            width: 100%;
            text-align: left;
            margin-bottom: 4px;
        }

        .page-header h1 {
            font-size: 1.9rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        /* Seletor de Per√≠odo */
        .period-selector {
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .period-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .period-tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 48px;
        }

        .period-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .period-tab.active {
            background: var(--accent-orange);
            color: white;
            transform: translateY(-1px);
        }

        /* Glass card */
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 20px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .section-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0 0 16px 0;
            text-align: center;
        }

        /* Grid Unificado */
        .unified-progress-grid {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 20px;
            margin-top: 20px;
            width: 100%;
            grid-auto-rows: auto;
        }

        /* Progress Card Unificado */
        .unified-progress-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px 16px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            min-height: 160px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }

        .unified-progress-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .unified-progress-card .progress-icon {
            font-size: 2.2rem;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .unified-progress-card .progress-label {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 8px 0;
            flex-shrink: 0;
        }

        .unified-progress-card .progress-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 6px 0;
            flex-shrink: 0;
        }

        .unified-progress-card .progress-target {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin: 0 0 12px 0;
            flex-shrink: 0;
            line-height: 1.3;
        }

        .unified-progress-card .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .unified-progress-card .progress-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .unified-progress-card .progress-percentage {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            flex-shrink: 0;
        }

        /* Chart container */
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
            margin: 10px 0;
        }

        /* Spinner de Loading */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Progress summary grid */
        .progress-summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .progress-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px 16px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            min-height: 140px;
            transition: all 0.3s ease;
        }

        .progress-card .progress-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .progress-card .progress-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .progress-card .progress-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 4px 0;
        }

        .progress-card .progress-target {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin: 0;
        }

        @media (max-width: 768px) {
            .progress-page-grid {
                padding: 20px 6px 30px 6px;
            }
            
            .unified-progress-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            
            .unified-progress-card {
                min-height: 120px;
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="fixed-background"></div>
    <div id="alert-container"></div>
    
    <div class="app-container" id="progress-container" style="display: none;">
        <section class="progress-page-grid">
            <!-- Header da p√°gina -->
            <header class="page-header">
    <script src="./www-config.js"></script>
                <h1>Meu Progresso</h1>
                
                <!-- Seletor de Per√≠odo -->
                <div class="period-selector">
                    <div class="period-tabs">
                        <button class="period-tab active" data-period="today">
                            <span class="tab-icon">üìÖ</span>
                            <span class="tab-text">Hoje</span>
                        </button>
                        <button class="period-tab" data-period="week">
                            <span class="tab-icon">üìä</span>
                            <span class="tab-text">Semana</span>
                        </button>
                        <button class="period-tab" data-period="month">
                            <span class="tab-icon">üìà</span>
                            <span class="tab-text">M√™s</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- CARD UNIFICADO DE PROGRESSO -->
            <div class="glass-card">
                <h3 class="section-title">üìä Meu Progresso</h3>
                <p class="section-subtitle" id="period-subtitle">Consumo vs Meta - Hoje</p>
                
                <div class="unified-progress-grid" id="progress-content">
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p>Carregando dados...</p>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico de Evolu√ß√£o do Peso -->
            <div class="glass-card" id="weight-chart-card" style="display: none;">
                <h3 class="section-title">Evolu√ß√£o do Peso</h3>
                <p class="section-subtitle">√öltimos 30 dias</p>
                <div class="chart-container">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>

            <!-- Resumo de Peso -->
            <div class="glass-card" id="weight-summary-card" style="display: none;">
                <h3 class="section-title">Resumo de Peso</h3>
                <div class="progress-summary-grid">
                    <div class="progress-card">
                        <span class="progress-icon">‚öñÔ∏è</span>
                        <h4 class="progress-label">Peso Atual</h4>
                        <p class="progress-value" id="current-weight">-</p>
                        <p class="progress-target" id="weight-change">-</p>
                    </div>

                    <div class="progress-card">
                        <span class="progress-icon">üìä</span>
                        <h4 class="progress-label">Registros</h4>
                        <p class="progress-value" id="weight-records">0</p>
                        <p class="progress-target">pesagens em 30 dias</p>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Bottom Navigation (via JavaScript - funciona como include) -->
    <script>
        const bottomNavScript = document.createElement('script');
        bottomNavScript.src = './assets/js/bottom-nav.js?v=' + Date.now();
        document.head.appendChild(bottomNavScript);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let progressData = null;
        let weightChart = null;
        
        // Carregar dados do progresso
        (async function() {
            const authenticated = await requireAuth();
            if (!authenticated) return;
            
            const BASE_URL = window.BASE_APP_URL;
            
            try {
                const response = await authenticatedFetch(`${BASE_URL}/api/get_progress_data.php`);
                if (!response) return;
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Erro ao carregar dados');
                }
                
                const data = result.data;
                
                // Preparar dados para renderiza√ß√£o
                prepareProgressData(data);
                
                // Renderizar p√°gina
                renderProgressPage();
                
                // Mostrar conte√∫do
                document.getElementById('progress-container').style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao carregar progresso:', error);
                document.getElementById('progress-content').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: red;">Erro ao carregar dados. Tente novamente.</p>
                    </div>
                `;
            }
        })();
        
        function prepareProgressData(data) {
            const goals = data.goals || {};
            const today = data.today || {};
            const week = data.week || {};
            const month = data.month || {};
            
            // Calcular meta de √°gua com base no valor real enviado pelo backend (ml)
            const waterGoalMl = (typeof data.water_goal_ml === 'number' && data.water_goal_ml > 0)
                ? data.water_goal_ml
                : ((goals.target_water_cups || 0) * 250);
            const sleepGoalHours = 8; // Meta fixa de sono
            
            progressData = {
                today: {
                    kcal: today.kcal_consumed || 0,
                    protein: today.protein_consumed_g || 0,
                    carbs: today.carbs_consumed_g || 0,
                    fat: today.fat_consumed_g || 0,
                    water: today.water_consumed_ml != null 
                        ? today.water_consumed_ml 
                        : ((today.water_consumed_cups || 0) * 250),
                    steps: today.steps_daily || 0,
                    sleep: parseFloat(today.sleep_hours) || 0,
                    workout: today.workout_hours || 0,
                    cardio: today.cardio_hours || 0
                },
                week: {
                    kcal: week.total_kcal || 0,
                    protein: week.total_protein || 0,
                    carbs: week.total_carbs || 0,
                    fat: week.total_fat || 0,
                    water: (week.total_water || 0) * 250,
                    steps: week.total_steps || 0,
                    sleep: parseFloat(week.avg_sleep) || 0,
                    workout: week.total_workout_hours || 0,
                    cardio: week.total_cardio_hours || 0
                },
                month: {
                    kcal: month.total_kcal || 0,
                    protein: month.total_protein || 0,
                    carbs: month.total_carbs || 0,
                    fat: month.total_fat || 0,
                    water: (month.total_water || 0) * 250,
                    steps: month.total_steps || 0,
                    sleep: parseFloat(month.avg_sleep) || 0,
                    workout: month.total_workout_hours || 0,
                    cardio: month.total_cardio_hours || 0
                },
                goals: {
                    kcal: goals.target_kcal || 2000,
                    protein: goals.target_protein_g || 150,
                    carbs: goals.target_carbs_g || 200,
                    fat: goals.target_fat_g || 65,
                    water: waterGoalMl,
                    steps_daily: goals.target_steps_daily || 10000,
                    steps_weekly: goals.target_steps_weekly || 70000,
                    sleep: sleepGoalHours,
                    workout_weekly: goals.target_workout_hours_weekly || 0,
                    cardio_weekly: goals.target_cardio_hours_weekly || 0
                },
                user_has_exercises: data.user_has_exercises || false
            };
        }
        
        function formatNumber(number, decimals = 0) {
            return new Intl.NumberFormat('pt-BR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(number);
        }
        
        function formatHours(hours) {
            if (!hours || hours < 0) hours = 0;
            if (hours < 1) return Math.round(hours * 60) + 'min';
            const wholeHours = Math.floor(hours);
            const remainingMinutes = Math.round((hours - wholeHours) * 60);
            return remainingMinutes === 0 ? wholeHours + 'h' : wholeHours + 'h' + remainingMinutes;
        }
        
        function getProgressColor(percentage) {
            if (percentage >= 100) return '#22c55e';
            if (percentage >= 80) return '#f59e0b';
            if (percentage >= 60) return '#f97316';
            return '#ef4444';
        }
        
        function calculateProgress(current, target) {
            if (target <= 0) return 0;
            return Math.min(100, Math.round((current / target) * 100));
        }
        
        function renderProgressCards(period) {
            const content = document.getElementById('progress-content');
            if (!content || !progressData) return;
            
            let currentData, goalsData;
            
            switch(period) {
                case 'week':
                    currentData = progressData.week;
                    goalsData = {
                        kcal: progressData.goals.kcal * 7,
                        protein: progressData.goals.protein * 7,
                        carbs: progressData.goals.carbs * 7,
                        fat: progressData.goals.fat * 7,
                        water: progressData.goals.water * 7,
                        steps: progressData.goals.steps_weekly,
                        sleep: progressData.goals.sleep,
                        workout: progressData.goals.workout_weekly,
                        cardio: progressData.goals.cardio_weekly
                    };
                    break;
                case 'month':
                    currentData = progressData.month;
                    goalsData = {
                        kcal: progressData.goals.kcal * 30,
                        protein: progressData.goals.protein * 30,
                        carbs: progressData.goals.carbs * 30,
                        fat: progressData.goals.fat * 30,
                        water: progressData.goals.water * 30,
                        steps: progressData.goals.steps_daily * 30,
                        sleep: progressData.goals.sleep,
                        workout: progressData.goals.workout_weekly * 4,
                        cardio: progressData.goals.cardio_weekly * 4
                    };
                    break;
                case 'today':
                default:
                    currentData = progressData.today;
                    goalsData = {
                        kcal: progressData.goals.kcal,
                        protein: progressData.goals.protein,
                        carbs: progressData.goals.carbs,
                        fat: progressData.goals.fat,
                        water: progressData.goals.water,
                        steps: progressData.goals.steps_daily,
                        sleep: progressData.goals.sleep,
                        workout: progressData.goals.workout_weekly / 7,
                        cardio: progressData.goals.cardio_weekly / 7
                    };
                    break;
            }

            const cards = [
                { icon: 'üî•', label: 'Calorias', value: currentData.kcal, target: goalsData.kcal, unit: 'kcal' },
                { icon: 'ü•©', label: 'Prote√≠nas', value: currentData.protein, target: goalsData.protein, unit: 'g' },
                { icon: 'üçû', label: 'Carboidratos', value: currentData.carbs, target: goalsData.carbs, unit: 'g' },
                { icon: 'ü•ë', label: 'Gorduras', value: currentData.fat, target: goalsData.fat, unit: 'g' },
                { icon: 'üíß', label: '√Ågua', value: currentData.water, target: goalsData.water, unit: 'ml' },
                { icon: 'üò¥', label: 'Sono', value: currentData.sleep, target: goalsData.sleep, unit: '', isHour: true }
            ];

            if (progressData.user_has_exercises && goalsData.workout > 0) {
                cards.push(
                    { icon: 'üèãÔ∏è', label: 'Treino', value: currentData.workout, target: goalsData.workout, unit: '', isHour: true },
                    { icon: 'üèÉ', label: 'Cardio', value: currentData.cardio, target: goalsData.cardio, unit: '', isHour: true }
                );
            }

            let cardsHTML = cards.map(card => {
                const progress = calculateProgress(card.value, card.target);
                const displayValue = card.isHour ? formatHours(card.value) : formatNumber(card.value, card.unit === 'g' ? 1 : 0);
                const displayTarget = card.isHour ? formatHours(card.target) : formatNumber(card.target, card.unit === 'g' ? 1 : 0);

                return `
                    <div class="unified-progress-card">
                        <span class="progress-icon">${card.icon}</span>
                        <h4 class="progress-label">${card.label}</h4>
                        <p class="progress-value">${displayValue} ${card.unit}</p>
                        <p class="progress-target">Meta: ${displayTarget} ${card.unit}</p>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: ${progress}%; background: ${getProgressColor(progress)};"></div>
                        </div>
                        <p class="progress-percentage">${progress}% ‚Ä¢ ${displayValue} de ${displayTarget}</p>
                    </div>
                `;
            }).join('');
            
            content.innerHTML = cardsHTML;
        }
        
        function changePeriod(period) {
            document.querySelectorAll('.period-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.period === period);
            });
            
            const subtitles = {
                'today': 'Consumo vs Meta - Hoje',
                'week': 'Total vs Meta - Esta Semana',
                'month': 'Total vs Meta - Este M√™s'
            };
            document.getElementById('period-subtitle').textContent = subtitles[period];
            
            renderProgressCards(period);
        }
        
        function renderProgressPage() {
            // Event listeners para per√≠odo
            document.querySelectorAll('.period-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    changePeriod(tab.dataset.period);
                });
            });
            
            // Renderizar per√≠odo inicial
            changePeriod('today');
        }
    </script>
</body>
</html>
