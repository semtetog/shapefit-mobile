<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script src="./www-config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ShapeFIT">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="ShapeFIT">
    <meta name="theme-color" content="transparent">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Script Critical - Define altura real do viewport -->
    <script>
        function setRealViewportHeight() { 
            const vh = window.innerHeight * 0.01; 
            document.documentElement.style.setProperty('--vh', `${vh}px`); 
        }
        setRealViewportHeight();
        window.addEventListener('resize', setRealViewportHeight);
        window.addEventListener('orientationchange', function() {
            setTimeout(setRealViewportHeight, 100);
        });
        
        document.addEventListener('touchmove', function(event) {
            const scrollable = event.target.closest('.app-container, .container');
            if (!scrollable) {
                event.preventDefault();
            }
        }, { passive: false });
    </script>
    
    <title>Diário Alimentar - ShapeFIT</title>
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- CSS Principal -->
    <link rel="stylesheet" href="./assets/css/style.css">
    
    <!-- Variáveis Globais -->
    <script>
        // BASE_APP_URL já foi definido pelo www-config.js
        if (!window.BASE_APP_URL) {
            window.BASE_APP_URL = window.location.origin + window.location.pathname.split('/').slice(0, -1).join('/');
            if (window.BASE_APP_URL.endsWith('/')) {
                window.BASE_APP_URL = window.BASE_APP_URL.slice(0, -1);
            }
        }
    </script>
    
    <!-- Auth Script -->
    <!-- App State - Gerencia estado para evitar recarregamentos -->
    <script src="./assets/js/app-state.js"></script>

<style>
        body {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        a, button, .btn, [role="button"] {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
/* === DIARY PAGE - ESTILO COMPACTO E MODERNO === */
        .app-container {
            padding-top: 24px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: calc(60px + env(safe-area-inset-bottom));
        }

.diary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
            padding: 0 24px;
}

.page-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.date-selector {
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(255, 255, 255, 0.04);
    padding: 8px 16px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.12);
}

.date-nav-arrow {
    color: var(--text-secondary);
    font-size: 16px;
    text-decoration: none;
    transition: color 0.2s ease;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.date-nav-arrow:hover {
    color: var(--accent-orange);
}

.date-nav-arrow.disabled {
    opacity: 0.3;
    pointer-events: none;
}

#current-diary-date {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 14px;
}

.nutrition-summary {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 16px;
    padding: 16px;
            margin: 0 24px 20px 24px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    text-align: center;
}

.nutrition-card {
    padding: 12px 8px;
}

.nutrition-card h3 {
    font-size: 11px;
    color: var(--text-secondary);
    margin: 0 0 6px 0;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.nutrition-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

.nutrition-goal {
    font-size: 10px;
    color: var(--text-secondary);
    margin-top: 2px;
}

.meals-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
            padding: 0 24px;
}

.meal-group {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 16px;
    overflow: hidden;
}

.meal-group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.02);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.meal-group-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.meal-group-total {
    font-size: 12px;
    color: var(--accent-orange);
    font-weight: 600;
}

.meal-items {
    padding: 12px 16px;
}

.meal-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.meal-item:last-child {
    border-bottom: none;
}

.meal-item-info {
    flex: 1;
}

.meal-item-name {
    font-size: 14px;
    color: var(--text-primary);
    margin: 0 0 2px 0;
    font-weight: 500;
}

.meal-item-details {
    font-size: 11px;
    color: var(--text-secondary);
    margin: 0;
}

.meal-item-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.meal-item-kcal {
    font-size: 12px;
    color: var(--accent-orange);
    font-weight: 600;
}

.meal-edit-btn {
    color: var(--text-secondary);
    font-size: 0.9rem;
    padding: 6px;
    border-radius: 6px;
    transition: all 0.2s ease;
    text-decoration: none;
}

.meal-edit-btn:hover {
    color: var(--accent-orange);
    background: rgba(255, 107, 0, 0.1);
}

.add-meal-section {
            margin: 20px 24px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 16px;
}

.add-meal-btn-integrated {
    width: 100%;
    height: 48px;
    border-radius: 12px;
    background: var(--accent-orange);
    border: none;
    color: #fff;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.add-meal-btn-integrated:hover {
    background: #ff7a1a;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
}

.empty-state i {
    font-size: 48px;
    color: var(--accent-orange);
    margin-bottom: 16px;
}

.empty-state h3 {
    font-size: 18px;
    color: var(--text-primary);
    margin: 0 0 8px 0;
}

.empty-state p {
    font-size: 14px;
    margin: 0;
}

@media (max-width: 768px) {
    .nutrition-summary {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        padding: 12px;
    }
    
    .nutrition-value {
        font-size: 14px;
    }
    
    .page-title {
        font-size: 20px;
    }
}
</style>
</head>
<body>
    <div class="fixed-background"></div>
    <div id="alert-container"></div>

<div class="app-container">
    <!-- Header com navegação de data -->
    <div class="diary-header">
        <h1 class="page-title">Diário</h1>
        <div class="date-selector">
            <a href="#" id="prev-date" class="date-nav-arrow">
                <i class="fas fa-chevron-left"></i>
            </a>
            <span id="current-diary-date">Carregando...</span>
            <a href="#" id="next-date" class="date-nav-arrow">
                <i class="fas fa-chevron-right"></i>
            </a>
        </div>
    </div>

    <!-- Resumo nutricional compacto -->
    <div class="nutrition-summary">
        <div class="nutrition-card">
            <h3>Calorias</h3>
            <div class="nutrition-value" id="kcal-consumed">0</div>
            <div class="nutrition-goal">/ <span id="kcal-goal">0</span> kcal</div>
        </div>
        <div class="nutrition-card">
            <h3>Proteínas</h3>
            <div class="nutrition-value" id="protein-consumed">0g</div>
            <div class="nutrition-goal">/ <span id="protein-goal">0</span>g</div>
        </div>
        <div class="nutrition-card">
            <h3>Carboidratos</h3>
            <div class="nutrition-value" id="carbs-consumed">0g</div>
            <div class="nutrition-goal">/ <span id="carbs-goal">0</span>g</div>
        </div>
        <div class="nutrition-card">
            <h3>Gorduras</h3>
            <div class="nutrition-value" id="fat-consumed">0g</div>
            <div class="nutrition-goal">/ <span id="fat-goal">0</span>g</div>
        </div>
    </div>

    <!-- Lista de refeições -->
    <div class="meals-list" id="meals-list">
        <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <h3>Carregando...</h3>
        </div>
    </div>

    <!-- Botão de adicionar refeição integrado -->
    <div class="add-meal-section">
        <button class="add-meal-btn-integrated" id="add-meal-btn">
            <i class="fas fa-plus"></i>
            <span>Adicionar Refeição</span>
        </button>
    </div>
</div>

    <!-- Bottom Navigation -->
    <script src="./assets/js/bottom-nav.js"></script>
    
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

<script>
        // Verificar autenticação antes de carregar dados
        (async function() {
            const authenticated = await requireAuth();
            if (!authenticated) {
                return; // Já redirecionou para login
            }
            
// Carregar dados do diário
            const BASE_URL = window.BASE_APP_URL;
            const urlParams = new URLSearchParams(window.location.search);
            // Função para obter data local no formato YYYY-MM-DD (não UTC)
            // Usar métodos que retornam valores no timezone local
            function getLocalDateString() {
                const now = new Date();
                // Usar métodos que retornam valores no timezone local do dispositivo
                const year = now.getFullYear();
                const month = now.getMonth() + 1; // getMonth() retorna 0-11, então +1
                const day = now.getDate();
                
                // Usar toLocaleString para garantir timezone local
                const localDateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // Verificação adicional: usar toLocaleDateString para confirmar
                const localDateParts = now.toLocaleDateString('pt-BR', {
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }).split('/');
                const verifiedDateStr = `${localDateParts[2]}-${localDateParts[1]}-${localDateParts[0]}`;
                
                console.log('[Diary] Data local obtida (getDate):', localDateStr);
                console.log('[Diary] Data local obtida (toLocaleDateString):', verifiedDateStr);
                console.log('[Diary] Hora atual:', now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0'));
                console.log('[Diary] Timezone:', Intl.DateTimeFormat().resolvedOptions().timeZone);
                
                // Retornar a data verificada (mais confiável)
                return verifiedDateStr;
            }
            
            let currentDate = urlParams.get('date') || getLocalDateString();
            console.log('[Diary] Data inicial:', currentDate);

async function loadDiaryData(date) {
    try {
                    // IMPORTANTE: A data aqui é apenas para exibição/navegação do usuário
                    // O servidor deve validar usando sua própria data/hora para operações críticas
                    // (ex: não permitir registrar refeições no futuro)
                    const token = getAuthToken();
                    const response = await authenticatedFetch(`${BASE_URL}/api/get_diary_data.php?date=${date}`);
                    
                    if (!response) return; // Token inválido, já redirecionou
                    
                    if (!response.ok) {
                        const text = await response.text();
                        console.error('Erro HTTP:', response.status, text);
                        throw new Error(`Erro ao carregar dados: ${response.status}`);
                    }
                    
                    const text = await response.text();
                    if (!text || text.trim() === '') {
                        throw new Error('Resposta vazia do servidor');
                    }
                    
                    let result;
                    try {
                        result = JSON.parse(text);
                    } catch (parseError) {
                        console.error('Erro ao parsear JSON:', parseError);
                        console.error('Texto recebido:', text);
                        throw new Error('Resposta inválida do servidor');
                    }
        
        if (!result.success) {
            throw new Error(result.message || 'Erro ao carregar dados');
        }
        
        const data = result.data;
        // Sempre usar a data que foi solicitada (já está em formato local)
        // Não usar data.date do servidor pois pode estar em UTC
        const requestedDate = date; // Data que foi solicitada (já está em formato local)
        currentDate = requestedDate; // Sempre usar a data que foi solicitada
        
        console.log('[Diary] Data solicitada:', requestedDate, 'Data do servidor:', data.date);
        
        // Atualizar data display - usar a data solicitada formatada localmente
        // Parsear a data solicitada (YYYY-MM-DD) e formatar como DD/MM/YYYY
        const [year, month, day] = requestedDate.split('-');
        const dateDisplay = `${day}/${month}/${year}`;
        document.getElementById('current-diary-date').textContent = dateDisplay;
        console.log('[Diary] Data exibida:', dateDisplay);
        
        // Atualizar navegação de data
        const prevLink = document.getElementById('prev-date');
        const nextLink = document.getElementById('next-date');
        // Função para formatar data como YYYY-MM-DD (local, não UTC)
        function formatDateLocal(dateStr) {
            const d = new Date(dateStr + 'T00:00:00'); // Forçar hora local
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Função para adicionar/subtrair dias (local)
        // Usar manipulação de string para evitar problemas de timezone
        function addDaysLocal(dateStr, days) {
            const [year, month, day] = dateStr.split('-').map(Number);
            const d = new Date(year, month - 1, day); // month é 0-indexed
            d.setDate(d.getDate() + days);
            // Usar métodos locais
            const newYear = d.getFullYear();
            const newMonth = String(d.getMonth() + 1).padStart(2, '0');
            const newDay = String(d.getDate()).padStart(2, '0');
            return `${newYear}-${newMonth}-${newDay}`;
        }
        
        const prevDate = addDaysLocal(date, -1);
        const nextDate = addDaysLocal(date, 1);
        
        prevLink.href = `?date=${prevDate}`;
        nextLink.href = `?date=${nextDate}`;
        
        const todayLocal = getLocalDateString();
        // Desabilitar "next" apenas se a data for maior ou igual a hoje (não pode ir para o futuro)
        // Se estiver em uma data anterior, deve poder voltar (next habilitado)
        if (date >= todayLocal) {
            nextLink.classList.add('disabled');
        } else {
            nextLink.classList.remove('disabled');
        }
        
        // O botão "prev" sempre deve estar habilitado (pode ir para datas anteriores)
        prevLink.classList.remove('disabled');
        
        // Atualizar resumo nutricional
        document.getElementById('kcal-consumed').textContent = data.nutrition.kcal.consumed;
        document.getElementById('kcal-goal').textContent = data.nutrition.kcal.goal;
        document.getElementById('protein-consumed').textContent = data.nutrition.protein.consumed + 'g';
        document.getElementById('protein-goal').textContent = data.nutrition.protein.goal;
        document.getElementById('carbs-consumed').textContent = data.nutrition.carbs.consumed + 'g';
        document.getElementById('carbs-goal').textContent = data.nutrition.carbs.goal;
        document.getElementById('fat-consumed').textContent = data.nutrition.fat.consumed + 'g';
        document.getElementById('fat-goal').textContent = data.nutrition.fat.goal;
        
        // Renderizar refeições (garantir que meal_groups seja um objeto)
        const mealGroups = data.meal_groups || {};
        const mealTypes = data.meal_types || {};
        renderMeals(mealGroups, mealTypes);
        
        // Atualizar botão de adicionar
        document.getElementById('add-meal-btn').onclick = () => {
                        window.location.href = `./add_food_to_diary.html?date=${currentDate}`;
        };
        
    } catch (error) {
        console.error('Erro ao carregar dados do diário:', error);
        document.getElementById('meals-list').innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Erro ao carregar dados</h3>
                <p>${error.message}</p>
            </div>
        `;
    }
}

function renderMeals(mealGroups, mealTypes) {
    const mealsList = document.getElementById('meals-list');
    
    // Verificar se mealGroups é array (formato da API) ou objeto (formato esperado)
    let processedGroups = {};
    
    if (Array.isArray(mealGroups)) {
        // Converter array para objeto
        mealGroups.forEach(group => {
            if (group && group.type && Array.isArray(group.meals)) {
                processedGroups[group.type] = group.meals;
            }
        });
    } else if (mealGroups && typeof mealGroups === 'object') {
        // Já é objeto, usar diretamente
        processedGroups = mealGroups;
    }
    
    if (Object.keys(processedGroups).length === 0) {
        mealsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-utensils"></i>
                <h3>Nenhuma refeição registrada</h3>
                <p>Adicione sua primeira refeição do dia</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    for (const [mealType, meals] of Object.entries(processedGroups)) {
        // Garantir que meals seja um array
        if (!Array.isArray(meals)) {
            console.warn(`mealGroups[${mealType}] não é um array:`, meals);
            continue;
        }
        
        const typeName = mealTypes[mealType] || mealType;
        const mealGroupKcal = meals.reduce((sum, meal) => sum + parseFloat(meal.kcal_consumed || 0), 0);
        
        html += `
            <div class="meal-group">
                <div class="meal-group-header">
                    <h3 class="meal-group-title">${escapeHtml(typeName)}</h3>
                    <div class="meal-group-total">${Math.round(mealGroupKcal)} kcal</div>
                </div>
                <div class="meal-items">
        `;
        
        meals.forEach(meal => {
            const mealName = meal.recipe_name || meal.custom_meal_name || 'Refeição';
            html += `
                    <div class="meal-item">
                        <div class="meal-item-info">
                            <div class="meal-item-name">${escapeHtml(mealName)}</div>
                            <div class="meal-item-details">
                                P: ${Math.round(meal.protein_consumed_g || 0)}g | 
                                C: ${Math.round(meal.carbs_consumed_g || 0)}g | 
                                G: ${Math.round(meal.fat_consumed_g || 0)}g
                            </div>
                        </div>
                        <div class="meal-item-actions">
                            <div class="meal-item-kcal">${Math.round(meal.kcal_consumed || 0)} kcal</div>
                                        <a href="./edit_meal.html?id=${meal.id}" class="meal-edit-btn" title="Editar refeição">
                                <i class="fas fa-edit"></i>
                            </a>
                        </div>
                    </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    mealsList.innerHTML = html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Carregar dados ao iniciar
loadDiaryData(currentDate);
        })();
</script>
</body>
</html>
