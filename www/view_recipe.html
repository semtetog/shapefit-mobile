<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script src="./www-config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ShapeFIT">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="ShapeFIT">
    <meta name="theme-color" content="transparent">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Script Critical -->
    <script>
        function setRealViewportHeight() { 
            const vh = window.innerHeight * 0.01; 
            document.documentElement.style.setProperty('--vh', `${vh}px`); 
        }
        setRealViewportHeight();
        window.addEventListener('resize', setRealViewportHeight);
        window.addEventListener('orientationchange', function() {
            setTimeout(setRealViewportHeight, 100);
        });
        
        document.addEventListener('touchmove', function(event) {
            const scrollable = event.target.closest('.app-container, .container');
            if (!scrollable) {
                event.preventDefault();
            }
        }, { passive: false });
    </script>
    
    <title id="page-title">Receita - ShapeFIT</title>
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- CSS Principal -->
    <link rel="stylesheet" href="./assets/css/style.css">
    
    <!-- Variáveis Globais -->
    <script>
        // BASE_APP_URL já foi definido pelo www-config.js
        if (!window.BASE_APP_URL) {
            window.BASE_APP_URL = window.location.origin + window.location.pathname.split('/').slice(0, -1).join('/');
            if (window.BASE_APP_URL.endsWith('/')) {
                window.BASE_APP_URL = window.BASE_APP_URL.slice(0, -1);
            }
        }
    </script>
    
    <!-- Helpers e Auth -->
    <script src="./assets/js/common.js"></script>
    <script src="./assets/js/auth.js"></script>
    <script>
        if (typeof getLocalDateString !== 'function') {
            window.getLocalDateString = function(date = null) {
                const d = date ? new Date(date) : new Date();
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
        }
        if (typeof addDaysLocal !== 'function') {
            window.addDaysLocal = function(dateStr, days) {
                const d = new Date(dateStr + 'T00:00:00');
                d.setDate(d.getDate() + days);
                return getLocalDateString(d);
            };
        }
    </script>
    
    <style>
        body {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        a, button, .btn, [role="button"] {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
    </style>
    
<style>
/* === VIEW RECIPE - ESTILO COMPLETO === */

/* === HEADER === */
.recipe-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.back-button {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-primary);
    text-decoration: none;
    transition: all 0.2s ease;
}

.back-button:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateX(-2px);
}

.recipe-action-favorite {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
}

.recipe-action-favorite.is-favorited {
    background: var(--accent-orange) !important;
    border-color: var(--accent-orange) !important;
    color: #fff !important;
}

.recipe-action-favorite:hover {
    background: rgba(255, 255, 255, 0.08);
}

.recipe-action-favorite:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.08);
}

.recipe-action-favorite.is-favorited:focus {
    background: var(--accent-orange) !important;
    border-color: var(--accent-orange) !important;
    color: #fff !important;
}

/* === GARANTIR QUE O FAVORITE_LOGIC.JS FUNCIONE === */
.favorite-toggle-btn {
    cursor: pointer !important;
    pointer-events: auto !important;
}

.favorite-toggle-btn i {
    pointer-events: none !important;
}

/* === FORÇAR ESTADO ATIVO DO FAVORITO === */
.favorite-toggle-btn.is-favorited {
    background: var(--accent-orange) !important;
    border-color: var(--accent-orange) !important;
    color: #fff !important;
}

.favorite-toggle-btn.is-favorited i {
    color: #fff !important;
}

.favorite-toggle-btn.is-favorited:hover {
    background: #ff7a1a !important;
    border-color: #ff7a1a !important;
}

.favorite-toggle-btn.is-favorited:focus {
    background: var(--accent-orange) !important;
    border-color: var(--accent-orange) !important;
    color: #fff !important;
}

/* === IMAGEM === */
.recipe-detail-image {
    width: 100%;
    height: 280px;
    object-fit: cover;
    border-radius: 20px;
    margin-bottom: 20px;
}

/* === CARD PRINCIPAL === */
.recipe-main-info {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 20px;
    transition: all 0.2s ease;
    overflow: hidden;
    word-wrap: break-word;
    overflow-wrap: break-word;
    box-sizing: border-box;
}

.recipe-main-info:hover {
    background: rgba(255, 255, 255, 0.06);
}

.recipe-name-main {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 12px 0;
    line-height: 1.2;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    max-width: 100%;
    overflow: hidden;
}

.recipe-description-short {
    font-size: 16px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin: 0 0 16px 0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    max-width: 100%;
    overflow: hidden;
}

.category-tags-container { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 8px; 
    margin-top: 0; 
}

.category-tag { 
    display: inline-block; 
    padding: 6px 12px; 
    background: rgba(255, 255, 255, 0.04); 
    border: 1px solid rgba(255, 255, 255, 0.12); 
    border-radius: 16px; 
    font-size: 13px; 
    color: var(--text-secondary); 
    text-decoration: none; 
    transition: all 0.2s ease;
    cursor: default;
    pointer-events: none;
}

/* === MACROS === */
.recipe-macros-summary {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 20px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    text-align: center;
    transition: all 0.2s ease;
}

.recipe-macros-summary:hover {
    background: rgba(255, 255, 255, 0.06);
}

.macro-info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.macro-info-item .value {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-primary);
}

.macro-info-item .label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.recipe-serving-info {
    grid-column: 1 / -1;
    font-size: 12px;
    color: var(--text-secondary);
    margin: 12px 0 0 0;
    text-align: center;
}

/* === TEMPO E PORÇÕES === */
.recipe-timing-servings {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
}

.recipe-timing-servings:hover {
    background: rgba(255, 255, 255, 0.06);
}

.timing-item, .servings-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-secondary);
    font-size: 14px;
}

.timing-item i, .servings-item i {
    color: var(--accent-orange);
    width: 16px;
}

/* === SEÇÕES === */
.recipe-section {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 20px;
    transition: all 0.2s ease;
}

.recipe-section:hover {
    background: rgba(255, 255, 255, 0.06);
}

.recipe-section-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 16px 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.recipe-section-title::before {
    content: '';
    width: 4px;
    height: 20px;
    background: var(--accent-orange);
    border-radius: 2px;
}

/* === INGREDIENTES === */
.recipe-ingredient-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.recipe-ingredient-list li {
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    color: var(--text-secondary);
    font-size: 15px;
    line-height: 1.4;
    position: relative;
    padding-left: 20px;
}

.recipe-ingredient-list li:last-child {
    border-bottom: none;
}

.recipe-ingredient-list li::before {
    content: '•';
    color: var(--accent-orange);
    position: absolute;
    left: 0;
    top: 12px;
}

/* === INSTRUÇÕES === */
.instruction-step {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
    padding: 16px;
    background: rgba(255, 255, 255, 0.02);
    border-radius: 12px;
    border-left: 3px solid var(--accent-orange);
}

.step-number {
    width: 28px;
    height: 28px;
    background: var(--accent-orange);
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
    flex-shrink: 0;
}

.instruction-step p {
    color: var(--text-secondary);
    line-height: 1.5;
    margin: 0;
}

/* === OBSERVAÇÕES === */
.recipe-notes-card {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 20px;
    transition: all 0.2s ease;
}

.recipe-notes-card:hover {
    background: rgba(255, 255, 255, 0.06);
}

/* === REGISTRAR REFEIÇÃO === */
.register-meal-section {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 20px;
    padding: 24px;
    margin-bottom: 20px;
    transition: all 0.2s ease;
}

.register-meal-section:hover {
    background: rgba(255, 255, 255, 0.06);
}

.register-meal-section .recipe-section-title {
    text-align: center;
}

/* === FORMULÁRIO === */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 8px;
}

.form-control {
    width: 100%;
    height: 48px;
    padding: 0 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 15px;
    transition: all 0.2s ease;
    box-sizing: border-box;
}

.form-control:focus {
    outline: none;
    border-color: var(--accent-orange);
    background: rgba(255, 255, 255, 0.08);
}

.btn-primary {
    width: 100%;
    height: 52px;
    background: var(--accent-orange);
    border: none;
    border-radius: 16px;
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary:hover {
    background: #ff7a1a;
}

/* === RESPONSIVIDADE === */
@media (max-width: 768px) {
    .recipe-name-main {
        font-size: 24px;
    }
    
    .recipe-macros-summary {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .recipe-timing-servings {
        flex-direction: column;
        gap: 12px;
        text-align: center;
    }
}

/* === TOUCH PARA ELEMENTOS INTERATIVOS === */
.back-button,
.recipe-action-favorite,
.btn-primary,
.form-control,
.category-tag {
    touch-action: manipulation !important;
}

</style>
</head>
<body>
    <div class="fixed-background"></div>
    <div id="alert-container"></div>

    <div class="app-container" id="recipe-container" style="display: none;">
    <div class="header-nav recipe-detail-header">
        <a href="javascript:history.back()" class="back-button" aria-label="Voltar"><i class="fas fa-chevron-left"></i></a>
            <a href="#" id="favorite-btn" class="recipe-action-favorite favorite-toggle-btn" aria-label="Favoritar receita">
                <i class="far fa-heart"></i>
            </a>
    </div>

        <img id="recipe-image" src="" alt="" class="recipe-detail-image">

    <div class="recipe-main-info card-shadow-light">
            <h1 class="recipe-name-main" id="recipe-name"></h1>
            <p class="recipe-description-short" id="recipe-description" style="display: none;"></p>
            <div class="category-tags-container" id="category-tags" style="display: none;"></div>
    </div>

        <div class="recipe-macros-summary card-shadow-light" id="recipe-macros">
            <div class="macro-info-item"><span class="value" id="macro-kcal">0</span><span class="label">Kcal</span></div>
            <div class="macro-info-item"><span class="value" id="macro-carbs">0g</span><span class="label">Carbo</span></div>
            <div class="macro-info-item"><span class="value" id="macro-fat">0g</span><span class="label">Gordura</span></div>
            <div class="macro-info-item"><span class="value" id="macro-protein">0g</span><span class="label">Proteína</span></div>
            <p class="recipe-serving-info" id="serving-info"></p>
        </div>

        <div class="recipe-timing-servings card-shadow-light" id="timing-servings" style="display: none;"></div>

        <div class="recipe-section card-shadow-light" id="ingredients-section" style="display: none;">
        <h3 class="recipe-section-title">Ingredientes</h3>
            <ul class="recipe-ingredient-list" id="ingredients-list"></ul>
    </div>

        <div class="recipe-section card-shadow-light" id="instructions-section" style="display: none;">
        <h3 class="recipe-section-title">Modo de Preparo</h3>
            <div class="recipe-instructions" id="instructions-content"></div>
        </div>

        <div class="recipe-section recipe-notes-card card-shadow-light" id="notes-section" style="display: none;">
        <h3 class="recipe-section-title">Observação</h3>
            <p id="notes-content"></p>
    </div>

    <div class="register-meal-section card-shadow">
        <h3 class="recipe-section-title text-center">Registrar esta Refeição</h3>
            <form id="log-meal-form">
                <input type="hidden" name="recipe_id" id="recipe_id" value="">
            <div class="form-group">
                <label for="meal_type">Refeição:</label>
                    <select name="meal_type" id="meal_type" class="form-control"></select>
            </div>
            <div class="form-group">
                <label for="date_consumed">Data:</label>
                    <select name="date_consumed" id="date_consumed" class="form-control"></select>
            </div>
             <div class="form-group">
                <label for="servings_consumed">Porções consumidas:</label>
                <input type="number" name="servings_consumed" id="servings_consumed" class="form-control" value="1.0" min="0.1" step="0.1" required>
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Registrar no Diário</button>
        </form>
    </div>
</div>

    <div id="loading-state" style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
        <i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 16px;"></i>
        <p>Carregando receita...</p>
    </div>

    <!-- Bottom Navigation -->
    <script src="./assets/js/bottom-nav.js"></script>
    
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    
    <script>
        // Verificar autenticação
        (async function() {
            const authenticated = await requireAuth();
            if (!authenticated) {
                return; // Já redirecionou para login
            }
            
            const BASE_URL = window.BASE_APP_URL;
            const urlParams = new URLSearchParams(window.location.search);
            const recipeId = parseInt(urlParams.get('id')) || 0;
            
            if (!recipeId) {
                alert('ID da receita inválido.');
            const targetUrl = './explore_recipes.html';
            if (window.smoothNavigate) {
                window.smoothNavigate(targetUrl);
            } else {
                window.location.href = targetUrl;
            }
                return;
            }
            
            let recipeData = null;
            let isFavorited = false;
            
            // Carregar dados da receita
            async function loadRecipeData() {
                try {
                    const response = await authenticatedFetch(`${BASE_URL}/api/get_recipe_data.php?id=${recipeId}`);
                    
                    if (!response) return; // Token inválido, já redirecionou
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.message || 'Erro ao carregar receita');
                    }
                    
                    recipeData = result.data.recipe;
                    isFavorited = result.data.is_favorited;
                    
                    // Atualizar título
                    document.getElementById('page-title').textContent = recipeData.name + ' - ShapeFIT';
                    
                    // Renderizar receita
                    renderRecipe(result.data);
                    
                    // Configurar favorito
                    setupFavoriteButton();
                    
                    // Configurar formulário
                    setupLogMealForm(result.data);
                    
                    // Mostrar conteúdo
                    document.getElementById('loading-state').style.display = 'none';
                    document.getElementById('recipe-container').style.display = 'block';
                    
                } catch (error) {
                    console.error('Erro ao carregar receita:', error);
                    document.getElementById('loading-state').innerHTML = `
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px; color: var(--accent-orange);"></i>
                        <p>Erro ao carregar receita. Redirecionando...</p>
                    `;
                    setTimeout(() => {
                        const targetUrl = './explore_recipes.html';
                        if (window.smoothNavigate) {
                            window.smoothNavigate(targetUrl);
                        } else {
                            window.location.href = targetUrl;
                        }
                    }, 2000);
                }
            }
            
            function renderRecipe(data) {
                const recipe = data.recipe;
                const BASE_URL = window.BASE_APP_URL;
                
                // Imagem
                const imageUrl = recipe.image_url 
                    || (recipe.image_filename 
                        ? `${BASE_URL}/assets/images/recipes/${recipe.image_filename}`
                        : `${BASE_URL}/assets/images/recipes/placeholder_food.jpg`);
                document.getElementById('recipe-image').src = imageUrl;
                document.getElementById('recipe-image').onerror = function() {
                    this.src = `${BASE_URL}/assets/images/recipes/placeholder_food.jpg`;
                };
                document.getElementById('recipe-image').alt = recipe.name;
                
                // Nome
                document.getElementById('recipe-name').textContent = recipe.name;
                
                // Descrição
                if (recipe.description) {
                    document.getElementById('recipe-description').textContent = recipe.description;
                    document.getElementById('recipe-description').style.display = 'block';
                }
                
                // Categorias
                if (data.categories && data.categories.length > 0) {
                    const categoriesHtml = data.categories.map(cat => 
                        `<span class="category-tag">${escapeHtml(cat.name)}</span>`
                    ).join('');
                    document.getElementById('category-tags').innerHTML = categoriesHtml;
                    document.getElementById('category-tags').style.display = 'flex';
                }
                
                // Macros
                document.getElementById('macro-kcal').textContent = Math.round(recipe.kcal_per_serving || 0);
                document.getElementById('macro-carbs').textContent = (recipe.carbs_g_per_serving || 0).toFixed(1).replace('.', ',') + 'g';
                document.getElementById('macro-fat').textContent = (recipe.fat_g_per_serving || 0).toFixed(1).replace('.', ',') + 'g';
                document.getElementById('macro-protein').textContent = (recipe.protein_g_per_serving || 0).toFixed(1).replace('.', ',') + 'g';
                
                // Info de porção
                let servingInfo = 'Valores por porção';
                if (recipe.serving_size_g && recipe.serving_size_g > 0) {
                    servingInfo += ' de ' + Math.round(recipe.serving_size_g) + 'g';
                }
                document.getElementById('serving-info').textContent = servingInfo;
                
                // Tempo e porções
                const totalTime = (recipe.prep_time_minutes || 0) + (recipe.cook_time_minutes || 0);
                if (totalTime > 0 || recipe.servings) {
                    let timingHtml = '';
                    if (totalTime > 0) {
                        timingHtml += `<div class="timing-item"><i class="far fa-clock"></i> ${totalTime} min</div>`;
                    }
                    if (recipe.servings) {
                        let servingsText = "Rende " + recipe.servings;
                        servingsText += (parseInt(recipe.servings) === 1) ? ' porção' : ' porções';
                        if (recipe.serving_size_g && recipe.serving_size_g > 0) {
                            servingsText += ' de ' + Math.round(recipe.serving_size_g) + 'g';
                        }
                        timingHtml += `<div class="servings-item"><i class="fas fa-utensils"></i> ${servingsText}</div>`;
                    }
                    document.getElementById('timing-servings').innerHTML = timingHtml;
                    document.getElementById('timing-servings').style.display = 'flex';
                }
                
                // Ingredientes
                if (data.ingredients && data.ingredients.length > 0) {
                    const ingredientsHtml = data.ingredients.map(ing => 
                        `<li>- ${escapeHtml(ing)}</li>`
                    ).join('');
                    document.getElementById('ingredients-list').innerHTML = ingredientsHtml;
                    document.getElementById('ingredients-section').style.display = 'block';
                }
                
                // Instruções
                if (recipe.instructions) {
                    const steps = recipe.instructions.split('\n').filter(s => s.trim());
                    let stepNumber = 1;
                    const instructionsHtml = steps.map(step => {
                        const cleaned = step.trim().replace(/^\d+[\.\)]\s*/, '');
                        return `<div class="instruction-step"><span class="step-number">${stepNumber++}</span><p>${escapeHtml(cleaned).replace(/\n/g, '<br>')}</p></div>`;
                    }).join('');
                    document.getElementById('instructions-content').innerHTML = instructionsHtml;
                    document.getElementById('instructions-section').style.display = 'block';
                }
                
                // Notas
                if (recipe.notes) {
                    document.getElementById('notes-content').innerHTML = escapeHtml(recipe.notes).replace(/\n/g, '<br>');
                    document.getElementById('notes-section').style.display = 'block';
                }
            }
            
            function setupFavoriteButton() {
                const favoriteBtn = document.getElementById('favorite-btn');
                const favoriteIcon = favoriteBtn.querySelector('i');
                
                if (isFavorited) {
                    favoriteBtn.classList.add('is-favorited');
                    favoriteIcon.className = 'fas fa-heart';
                    favoriteBtn.setAttribute('aria-label', 'Desfavoritar receita');
                } else {
                    favoriteBtn.classList.remove('is-favorited');
                    favoriteIcon.className = 'far fa-heart';
                    favoriteBtn.setAttribute('aria-label', 'Favoritar receita');
                }
                
                favoriteBtn.onclick = async function(e) {
                    e.preventDefault();
                    
                    try {
                        const response = await authenticatedFetch(`${BASE_URL}/api/toggle_favorite.php`, {
                            method: 'POST',
                            body: JSON.stringify({ recipe_id: recipeId })
                        });
                        
                        if (!response) return; // Token inválido, já redirecionou
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            isFavorited = result.is_favorited;
                            if (isFavorited) {
                                favoriteBtn.classList.add('is-favorited');
                                favoriteIcon.className = 'fas fa-heart';
                                favoriteBtn.setAttribute('aria-label', 'Desfavoritar receita');
                            } else {
                                favoriteBtn.classList.remove('is-favorited');
                                favoriteIcon.className = 'far fa-heart';
                                favoriteBtn.setAttribute('aria-label', 'Favoritar receita');
                            }
                        }
                    } catch (error) {
                        console.error('Erro ao favoritar:', error);
                    }
                };
            }
            
            function setupLogMealForm(data) {
                document.getElementById('recipe_id').value = recipeId;
                
                // Preencher meal type
                const mealTypeSelect = document.getElementById('meal_type');
                mealTypeSelect.innerHTML = '';
                for (const [slug, name] of Object.entries(data.meal_type_options)) {
                    const option = document.createElement('option');
                    option.value = slug;
                    option.textContent = name;
                    if (slug === data.default_meal_type) {
                        option.selected = true;
                    }
                    mealTypeSelect.appendChild(option);
                }
                
                // Preencher data
                const dateSelect = document.getElementById('date_consumed');
                // Função para obter data local (não UTC)
                function getLocalDateString(date = null) {
                    const d = date ? new Date(date) : new Date();
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                function addDaysLocal(dateStr, days) {
                    const d = new Date(dateStr + 'T00:00:00');
                    d.setDate(d.getDate() + days);
                    return getLocalDateString(d);
                }
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                dateSelect.innerHTML = `
                    <option value="${getLocalDateString()}">Hoje, ${today.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})}</option>
                    <option value="${addDaysLocal(getLocalDateString(), -1)}">Ontem, ${yesterday.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})}</option>
                `;
                
                // Submit do formulário
                document.getElementById('log-meal-form').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = {
                        recipe_id: recipeId,
                        meal_type: document.getElementById('meal_type').value,
                        date_consumed: document.getElementById('date_consumed').value,
                        servings_consumed: parseFloat(document.getElementById('servings_consumed').value)
                    };
                    
                    try {
                        const response = await authenticatedFetch(`${BASE_URL}/api/log_meal.php`, {
                            method: 'POST',
                            body: JSON.stringify(formData)
                        });
                        
                        if (!response) return; // Token inválido, já redirecionou
                        
                        let resultText = '';
                        let result = {};
                        try {
                            resultText = await response.text();
                            result = resultText ? JSON.parse(resultText) : {};
                        } catch (parseError) {
                            console.error('Resposta não é um JSON válido:', resultText);
                            throw new Error(resultText || 'Resposta inválida do servidor');
                        }
                        
                        if (result.success) {
                            alert(result.message || 'Refeição registrada com sucesso!');
                            // Sempre usar caminho relativo para manter dentro do app (preferir SPA)
                            const targetUrl = './diary.html';
                            if (window.smoothNavigate) {
                                window.smoothNavigate(targetUrl);
                            } else {
                                window.location.href = targetUrl;
                            }
                        } else {
                            alert(result.message || 'Erro ao registrar refeição.');
                        }
                    } catch (error) {
                        console.error('Erro ao registrar refeição:', error);
                        alert('Erro ao registrar refeição. Tente novamente.');
                    }
                });
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Carregar dados
            loadRecipeData();
        })();
    </script>
</body>
</html>