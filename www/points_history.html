<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script src="./www-config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Minha Jornada - ShapeFIT</title>
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- CSS -->
    <script>
        // BASE_APP_URL já foi definido pelo www-config.js
        if (!window.BASE_APP_URL) { window.BASE_APP_URL = window.location.origin + window.location.pathname.split('/').slice(0, -1).join('/'); } if (window.BASE_APP_URL && window.BASE_APP_URL.endsWith('/')) {
            window.BASE_APP_URL = window.BASE_APP_URL.slice(0, -1);
        }
    </script>
    
    <style>
        body { 
            background-color: var(--bg-color); 
            color: var(--text-primary);
            margin: 0;
            min-height: 100vh;
        }
        
        .app-container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: calc(24px + env(safe-area-inset-top, 0px)) 0 calc(60px + env(safe-area-inset-bottom, 0px)) 0; 
            min-height: 100vh; 
            box-sizing: border-box;
        }

        .page-header { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            padding: 0 24px; 
            margin-bottom: 2rem; 
        }
        
        .back-button { 
            font-size: 1.5rem; 
            color: var(--text-primary); 
            text-decoration: none; 
        }
        
        .page-title { 
            font-size: 1.75rem; 
            font-weight: 700; 
            margin: 0; 
        }

        .content-wrapper { 
            padding: 0 24px; 
            padding-bottom: calc(40px + env(safe-area-inset-bottom, 0px)); 
        }

        /* Card Principal (Herói) */
        .hero-card { background-color: var(--surface-color); border-radius: 16px; padding: 20px; margin-bottom: 24px; }
        .hero-points-display { text-align: center; margin-bottom: 16px; }
        .points-value { font-size: 3.5rem; font-weight: 700; line-height: 1; color: var(--text-primary); }
        .points-label { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); letter-spacing: 1px; }
        .level-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .level-tag { background-color: var(--glass-bg); color: var(--accent-orange); padding: 6px 12px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; }
        .progress-bar-container { width: 100%; height: 8px; background-color: var(--glass-bg); border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background-image: var(--primary-orange-gradient); border-radius: 4px; transition: width 0.5s ease; }
        .next-level-text { font-size: 0.85rem; color: var(--text-secondary); text-align: center; margin-top: 8px; }

        /* Barra de Filtro */
        .filter-bar { background-color: var(--surface-color); border-radius: 12px; padding: 12px; }
        .filter-bar select { 
            width: 100%; 
            background-color: var(--glass-bg); 
            border: 1px solid var(--border-color); 
            color: var(--text-primary); 
            border-radius: 8px; 
            padding: 10px 40px 10px 12px; 
            font-size: 1rem; 
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23FF7A1A' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            cursor: pointer;
        }
        .filter-bar select:focus {
            outline: none;
            border-color: var(--accent-orange);
        }

        /* Histórico */
        .history-feed { margin-top: 24px; }
        .feed-date-separator { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin: 24px 0 12px; }
        .feed-group { background-color: var(--surface-color); border-radius: 16px; }
        .feed-item { display: flex; align-items: center; padding: 12px 16px; gap: 12px; border-bottom: 1px solid var(--border-color); }
        .feed-group .feed-item:last-child { border-bottom: none; }
        .feed-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .feed-icon i { font-size: 1.2rem; }
        .feed-info { flex-grow: 1; }
        .feed-reason { margin: 0; font-weight: 500; }
        .feed-time { font-size: 0.85rem; color: var(--text-secondary); }
        .feed-points { font-weight: 600; font-size: 1rem; color: #4CAF50; }

        /* Estado Vazio */
        .feed-empty-state { text-align: center; padding: 40px 20px; opacity: 0.7; }
        .feed-empty-state i { font-size: 2.5rem; margin-bottom: 16px; }
    </style>
</head>
<body>
    <div class="fixed-background"></div>
    <div id="alert-container"></div>
    
    <div class="app-container" id="points-container" style="display: none;">
        <div class="page-header">
            <a href="./main_app.html" class="back-button"><i class="fas fa-arrow-left"></i></a>
            <h1 class="page-title">Minha Jornada</h1>
        </div>

        <div class="content-wrapper">
            <div class="hero-card">
                <div class="hero-points-display">
                    <span class="points-value" id="points-value">0</span>
                    <span class="points-label">PONTOS</span>
                </div>
                <div class="hero-level-progress">
                    <div class="level-info">
                        <span class="level-tag" id="level-tag">-</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="level-progress-bar" style="width: 0%;"></div>
                    </div>
                    <div class="next-level-text" id="next-level-text">
                        Carregando...
                    </div>
                </div>
            </div>
            
            <div class="filter-bar">
                <select id="month-filter">
                    <option>Carregando...</option>
                </select>
            </div>

            <div class="history-feed" id="history-feed">
                <div class="feed-empty-state">
                    <div class="spinner"></div>
                    <p>Carregando histórico...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script src="./assets/js/bottom-nav.js"></script>
    <script>
        let pointsData = null;
        // Função helper para obter mês atual (local)
        function getLocalMonthString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }
        let currentMonth = new URLSearchParams(window.location.search).get('month') || getLocalMonthString();
        
        // Carregar dados
        (async function() {
            const authenticated = await requireAuth();
            if (!authenticated) return;
            
            const BASE_URL = window.BASE_APP_URL;
            
            try {
                const response = await authenticatedFetch(`${BASE_URL}/api/get_points_history_data.php?month=${currentMonth}`);
                if (!response) return;
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Erro ao carregar dados');
                }
                
                pointsData = result.data;
                renderPointsPage();
                
                document.getElementById('points-container').style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao carregar histórico:', error);
                document.getElementById('history-feed').innerHTML = `
                    <div class="feed-empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erro ao carregar dados. Tente novamente.</p>
                    </div>
                `;
            }
        })();
        
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // Função helper para obter data local
            function getLocalDateStr() {
                const d = new Date();
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            function getYesterdayStr() {
                const d = new Date();
                d.setDate(d.getDate() - 1);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            if (dateStr === getLocalDateStr()) {
                return 'Hoje';
            } else if (dateStr === getYesterdayStr()) {
                return 'Ontem';
            } else {
                const days = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
                const months = ['janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
                return days[date.getDay()] + ', ' + date.getDate() + ' de ' + months[date.getMonth()];
            }
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
        
        function renderPointsPage() {
            if (!pointsData) return;
            
            // Atualizar pontos e nível
            document.getElementById('points-value').textContent = formatNumber(pointsData.user_points);
            document.getElementById('level-tag').textContent = pointsData.level.name;
            document.getElementById('level-progress-bar').style.width = pointsData.level.progress_percentage + '%';
            
            if (pointsData.level.is_max_level) {
                document.getElementById('next-level-text').innerHTML = '<strong>Você está no nível máximo!</strong>';
            } else {
                document.getElementById('next-level-text').innerHTML = 
                    'Faltam <strong>' + formatNumber(pointsData.level.points_remaining) + '</strong> pontos...';
            }
            
            // Renderizar meses disponíveis
            const monthSelect = document.getElementById('month-filter');
            monthSelect.innerHTML = '';
            if (pointsData.available_months && pointsData.available_months.length > 0) {
                pointsData.available_months.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month.month_key;
                    option.textContent = month.month_display;
                    if (month.month_key === currentMonth) {
                        option.selected = true;
                    }
                    monthSelect.appendChild(option);
                });
                
                monthSelect.addEventListener('change', function() {
                    window.location.href = `./points_history.html?month=${this.value}`;
                });
            }
            
            // Renderizar histórico
            const historyFeed = document.getElementById('history-feed');
            if (!pointsData.points_log || pointsData.points_log.length === 0) {
                historyFeed.innerHTML = `
                    <div class="feed-empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <h3>Nenhuma Atividade</h3>
                        <p>Não há registros de pontos para este período.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            pointsData.points_log.forEach(group => {
                html += `<div class="feed-date-separator">${formatDate(group.date)}</div>`;
                html += '<div class="feed-group">';
                
                group.entries.forEach(entry => {
                    const details = entry.details || { icon: 'fa-question-circle', text: 'Ação registrada', color: '#A0A0A0' };
                    html += `
                        <div class="feed-item">
                            <div class="feed-icon" style="background-color: ${details.color}20;">
                                <i class="fas ${details.icon}" style="color: ${details.color};"></i>
                            </div>
                            <div class="feed-info">
                                <p class="feed-reason">${escapeHtml(details.text)}</p>
                                <span class="feed-time">${formatTime(entry.timestamp)}</span>
                            </div>
                            <span class="feed-points">+${formatNumber(entry.points_awarded)}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            historyFeed.innerHTML = html;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
