<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script src="./www-config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Scanner Nativo - ShapeFIT</title>
    
    <!-- Fontes e Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">

    <script>
        if (!window.BASE_APP_URL) { 
            window.BASE_APP_URL = window.location.origin + window.location.pathname.split('/').slice(0, -1).join('/'); 
        }
    </script>

    <style>
        /* === ESTILO PARA SCANNER NATIVO === */
        :root {
            --scanner-border-color: #FF7A1A;
        }

        html {
            height: 100%;
            width: 100%;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #121212;
            font-family: 'Montserrat', sans-serif;
            color: white;
            transition: background-color 0.3s ease; 
        }

        /* Quando o scanner está ativo, o corpo fica transparente para ver a câmera atrás */
        body.scanner-active,
        html.scanner-active {
            background-color: transparent !important;
            background: transparent !important;
            --background: transparent !important;
        }

        body.scanner-active .scanner-container {
            background: transparent !important;
        }

        body.scanner-active .hide-on-scan {
            display: none;
        }

        .scanner-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* === A MÁGICA DA MÁSCARA (CSS MASK) === */
        .scan-mask {
            display: none;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        body.scanner-active .scan-mask {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scan-hole {
            width: 80%;
            max-width: 300px;
            aspect-ratio: 1/1;
            border-radius: 20px;
            position: relative;
            background: transparent !important;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85); 
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* Cantos ativos laranja - solução simples e compatível */
        .scan-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid var(--scanner-border-color);
        }

        .scan-corner.top-left {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 20px;
        }

        .scan-corner.top-right {
            top: -3px;
            right: -3px;
            border-left: none;
            border-bottom: none;
            border-top-right-radius: 20px;
        }

        .scan-corner.bottom-left {
            bottom: -3px;
            left: -3px;
            border-right: none;
            border-top: none;
            border-bottom-left-radius: 20px;
        }

        .scan-corner.bottom-right {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 20px;
        }

        .scan-line {
            width: 100%;
            height: 2px;
            background: var(--scanner-border-color);
            box-shadow: 0 0 4px var(--scanner-border-color);
            position: absolute;
            animation: scanMove 2s infinite linear;
        }

        @keyframes scanMove {
            0% { top: 10%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 90%; opacity: 0; }
        }

        /* UI Sobreposta */
        .ui-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: env(safe-area-inset-top) 20px 40px 20px;
            box-sizing: border-box;
            pointer-events: none;
        }

        .header-controls, .footer-controls {
            pointer-events: auto;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px);
            padding: 15px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-controls { justify-content: space-between; }
        .footer-controls { flex-direction: column; width: 100%; }

        .btn-icon {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .manual-input-group {
            display: flex; width: 100%; gap: 10px;
        }
        
        .manual-input {
            flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            padding: 12px; border-radius: 8px; color: white;
            font-size: 16px;
        }

        h1 { margin: 0; font-size: 18px; }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-box {
            background: #1e1e1e;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- Máscara Escura com o "Buraco" (Só aparece quando scanner ativo) -->
    <div class="scan-mask">
        <div class="scan-hole">
            <div class="scan-corner top-left"></div>
            <div class="scan-corner top-right"></div>
            <div class="scan-corner bottom-left"></div>
            <div class="scan-corner bottom-right"></div>
            <div class="scan-line"></div>
        </div>
    </div>

    <!-- Camada de UI (Fica por cima de tudo) -->
    <div class="ui-layer">
        <!-- Topo -->
        <div class="header-controls">
            <button class="btn-icon" onclick="stopScanAndLeave()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1>Escanear Produto</h1>
            <button class="btn-icon" onclick="toggleTorch()">
                <i class="fas fa-bolt"></i>
            </button>
        </div>

        <!-- Rodapé -->
        <div class="footer-controls">
            <div style="margin-bottom: 10px; font-size: 14px; text-align: center; opacity: 0.8;">
                Aponte a câmera para o código de barras
            </div>
            
            <div class="manual-input-group">
                <input type="number" id="manual-code" class="manual-input" placeholder="Ou digite o código aqui">
                <button class="btn-icon" style="border-radius: 8px; background: var(--scanner-border-color);" onclick="handleManual()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-box">
            <i class="fas fa-spinner fa-spin" style="font-size: 30px; color: var(--scanner-border-color); margin-bottom: 15px;"></i>
            <p>Buscando produto...</p>
        </div>
    </div>

    <script>
        // Acessar o plugin via Capacitor (sem import ES module)
        let BarcodeScanner = null;
        let isScanning = false;
        let isProcessingBarcode = false;
        let lastDetectedBarcode = null;
        let scanListener = null;

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const authenticated = await requireAuth();
                if (!authenticated) return;

                // Aguardar Capacitor estar pronto
                await new Promise(resolve => setTimeout(resolve, 300));

                // Acessar o plugin via Capacitor
                if (window.Capacitor && window.Capacitor.Plugins) {
                    // Tentar diferentes nomes possíveis do plugin
                    BarcodeScanner = window.Capacitor.Plugins.BarcodeScanner ||
                                    window.Capacitor.Plugins.CapacitorMlkitBarcodeScanning ||
                                    window.Capacitor.Plugins['@capacitor-mlkit/barcode-scanning'];
                }

                if (!BarcodeScanner) {
                    console.warn("Plugin de scanner ML Kit não encontrado.");
                    return;
                }

                // Verificar se está no dispositivo nativo
                let isNative = false;
                if (window.Capacitor) {
                    if (typeof window.Capacitor.isNativePlatform === 'function') {
                        isNative = window.Capacitor.isNativePlatform();
                    } else if (typeof window.Capacitor.getPlatform === 'function') {
                        isNative = window.Capacitor.getPlatform() !== 'web';
                    } else if (typeof window.Capacitor.isNative !== 'undefined') {
                        isNative = !!window.Capacitor.isNative;
                    }
                }
                if (!isNative) {
                    console.warn("Scanner ML Kit só funciona em dispositivos nativos.");
                    return;
                }

                // Verificar permissões
                try {
                    const status = await BarcodeScanner.checkPermissions();
                    if (status.camera === 'denied' || status.camera === 'prompt') {
                        const response = await BarcodeScanner.requestPermissions();
                        if (response.camera !== 'granted') {
                            console.warn('Permissão de câmera negada');
                            return;
                        }
                    }

                    // Aguardar antes de iniciar
                    await new Promise(resolve => setTimeout(resolve, 500));
                    startNativeScan();
                } catch (err) {
                    console.error('Erro ao verificar permissões:', err);
                }
            } catch (error) {
                console.error('Erro na inicialização:', error);
            }
        });

        async function startNativeScan() {
            if (isScanning) return;
            
            try {
                isScanning = true;
                
                // 1. Torna o HTML transparente para ver a Activity da câmera atrás
                document.body.classList.add('scanner-active');
                document.documentElement.classList.add('scanner-active');

                // 2. Configurar listener ANTES de iniciar o scanner
                scanListener = await BarcodeScanner.addListener('barcodeScanned', async (result) => {
                    // Proteção contra múltiplas detecções
                    if (isProcessingBarcode) {
                        console.log('Já processando código, ignorando detecção duplicada');
                        return;
                    }
                    
                    const barcodeValue = result.barcode.rawValue;
                    
                    // Ignorar se for o mesmo código detectado recentemente
                    if (lastDetectedBarcode === barcodeValue) {
                        console.log('Código duplicado ignorado:', barcodeValue);
                        return;
                    }
                    
                    // Marcar como processando IMEDIATAMENTE
                    isProcessingBarcode = true;
                    lastDetectedBarcode = barcodeValue;
                    
                    console.log('Barcode detectado:', barcodeValue);
                    
                    // Parar scanner IMEDIATAMENTE
                    await stopScan();
                    
                    // Delay para garantir que o scanner foi totalmente parado
                    setTimeout(() => {
                        handleSuccess(barcodeValue).finally(() => {
                            // Resetar flag após processar
                            setTimeout(() => {
                                isProcessingBarcode = false;
                                lastDetectedBarcode = null;
                            }, 2000);
                        });
                    }, 300);
                });

                // 3. Iniciar scanner
                await BarcodeScanner.startScan();

            } catch (error) {
                console.error("Erro ao iniciar scanner:", error);
                await stopScan();
                console.warn("Erro ao abrir câmera:", error.message || error);
            }
        }

        window.stopScan = async function() {
            if (!isScanning) return;
            
            isScanning = false;
            document.body.classList.remove('scanner-active');
            document.documentElement.classList.remove('scanner-active');
            
            try {
                // Remover listener primeiro
                if (scanListener) {
                    await BarcodeScanner.removeListener(scanListener);
                    scanListener = null;
                }
                
                // Parar scanner
                await BarcodeScanner.stopScan();
            } catch (e) { 
                console.warn('Erro ao parar scanner:', e); 
            }
        };

        window.stopScanAndLeave = async function() {
            await window.stopScan();
            window.history.back();
        };

        window.toggleTorch = async function() {
            try {
                await BarcodeScanner.toggleTorch();
            } catch (e) { 
                console.log("Flash não disponível"); 
            }
        };

        window.handleManual = function() {
            const code = document.getElementById('manual-code').value;
            if(code && code.length > 3) {
                handleSuccess(code);
            } else {
                alert('Digite um código válido');
            }
        };

        async function handleSuccess(barcode) {
            try {
                // Validar barcode
                if (!barcode || typeof barcode !== 'string') {
                    console.error('Barcode inválido:', barcode);
                    return;
                }

                // Vibrar (opcional) - com tratamento de erro
                try {
                    if(window.navigator && window.navigator.vibrate) {
                        window.navigator.vibrate(200);
                    }
                } catch (vibrateErr) {
                    console.warn('Erro ao vibrar:', vibrateErr);
                }

                // Mostrar loading com segurança
                try {
                    const loadingEl = document.getElementById('loading-overlay');
                    if (loadingEl) {
                        loadingEl.classList.add('active');
                    }
                } catch (loadingErr) {
                    console.warn('Erro ao mostrar loading:', loadingErr);
                }

                // Aguardar um pouco antes de fazer a requisição (evita crash)
                await new Promise(resolve => setTimeout(resolve, 200));

                try {
                    const url = `${window.BASE_APP_URL}/api/lookup_barcode.php?barcode=${encodeURIComponent(barcode)}`;
                    const response = await authenticatedFetch(url);
                    
                    if (!response || !response.ok) {
                        throw new Error(`HTTP ${response?.status || 'unknown'}`);
                    }
                    
                    const data = await response.json();

                    // Esconder loading
                    try {
                        const loadingEl = document.getElementById('loading-overlay');
                        if (loadingEl) {
                            loadingEl.classList.remove('active');
                        }
                    } catch (loadingErr) {
                        console.warn('Erro ao esconder loading:', loadingErr);
                    }

                    // Aguardar um pouco antes de redirecionar (evita crash)
                    await new Promise(resolve => setTimeout(resolve, 300));

                    if (data && data.success && data.data) {
                        // Redirecionar com dados
                        const params = new URLSearchParams({
                            barcode: barcode,
                            food_name: data.data.name || '',
                            brand_name: data.data.brand || '',
                            kcal_100g: data.data.kcal_100g || '',
                            protein_100g: data.data.protein_100g || '',
                            carbs_100g: data.data.carbs_100g || '',
                            fat_100g: data.data.fat_100g || ''
                        });
                        
                        // Usar try-catch no redirecionamento
                        try {
                            window.location.href = `create_custom_food.html?${params.toString()}`;
                        } catch (redirectErr) {
                            console.error('Erro ao redirecionar:', redirectErr);
                            // Fallback: tentar sem parâmetros
                            window.location.href = `create_custom_food.html?barcode=${encodeURIComponent(barcode)}`;
                        }
                    } else {
                        // Produto não encontrado
                        const params = new URLSearchParams({ barcode: barcode });
                        try {
                            window.location.href = `create_custom_food.html?${params.toString()}`;
                        } catch (redirectErr) {
                            console.error('Erro ao redirecionar:', redirectErr);
                        }
                    }
                } catch (fetchError) {
                    console.error('Erro ao buscar produto:', fetchError);
                    
                    // Esconder loading
                    try {
                        const loadingEl = document.getElementById('loading-overlay');
                        if (loadingEl) {
                            loadingEl.classList.remove('active');
                        }
                    } catch (loadingErr) {
                        console.warn('Erro ao esconder loading:', loadingErr);
                    }
                    
                    // Não mostrar alerta que pode crashar, apenas redirecionar
                    setTimeout(() => {
                        try {
                            window.location.href = `create_custom_food.html?barcode=${encodeURIComponent(barcode)}`;
                        } catch (redirectErr) {
                            console.error('Erro ao redirecionar após erro:', redirectErr);
                        }
                    }, 500);
                }
            } catch (error) {
                console.error('Erro geral em handleSuccess:', error);
                // Esconder loading
                try {
                    const loadingEl = document.getElementById('loading-overlay');
                    if (loadingEl) {
                        loadingEl.classList.remove('active');
                    }
                } catch (loadingErr) {
                    console.warn('Erro ao esconder loading:', loadingErr);
                }
                // Tentar redirecionar mesmo com erro
                setTimeout(() => {
                    try {
                        window.location.href = `create_custom_food.html?barcode=${encodeURIComponent(barcode)}`;
                    } catch (redirectErr) {
                        console.error('Erro crítico ao redirecionar:', redirectErr);
                    }
                }, 500);
            }
        }

        // Segurança: Garante que o scanner para se o usuário sair do app
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                window.stopScan();
            }
        });
        
        // Limpa ao sair da página
        window.addEventListener('beforeunload', () => {
            window.stopScan();
        });
    </script>
</body>
</html>
