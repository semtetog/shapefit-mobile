<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script src="./www-config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ShapeFIT">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="ShapeFIT">
    <meta name="theme-color" content="transparent">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Script Critical -->
    <script>
        function setRealViewportHeight() { 
            const vh = window.innerHeight * 0.01; 
            document.documentElement.style.setProperty('--vh', `${vh}px`); 
        }
        setRealViewportHeight();
        window.addEventListener('resize', setRealViewportHeight);
        window.addEventListener('orientationchange', function() {
            setTimeout(setRealViewportHeight, 100);
        });
        
        document.addEventListener('touchmove', function(event) {
            const scrollable = event.target.closest('.app-container, .container');
            if (!scrollable) {
                event.preventDefault();
            }
        }, { passive: false });
    </script>
    
    <title>Fotos e Medidas - ShapeFIT</title>
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- CSS Principal -->
    <link rel="stylesheet" href="./assets/css/style.css">
    
    <!-- Variáveis Globais -->
    <script>
        // BASE_APP_URL já foi definido pelo www-config.js
        if (!window.BASE_APP_URL) { window.BASE_APP_URL = window.location.origin + window.location.pathname.split('/').slice(0, -1).join('/'); } if (window.BASE_APP_URL && window.BASE_APP_URL.endsWith('/')) {
            window.BASE_APP_URL = window.BASE_APP_URL.slice(0, -1);
        }
    </script>
    
    <!-- Auth Script -->
    <script src="./assets/js/auth.js"></script>
    
    <style>
        body {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        a, button, .btn, [role="button"] {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

/* Estilos da página de medidas */
.measurements-page-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding: 20px 8px 15px 8px;
}

/* Header da página */
.page-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
    padding: calc(1.5rem + env(safe-area-inset-top, 0px)) 1rem 0;
}

.back-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.12);
    color: var(--text-primary);
    text-decoration: none;
    transition: all 0.3s ease;
}

.back-button:hover {
    background: rgba(255, 255, 255, 0.12);
    transform: translateX(-2px);
}

.page-header h1 {
    font-size: 1.9rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
}

/* Resumo atual */
.current-summary {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.summary-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    padding: 20px 16px;
    text-align: center;
    min-height: 120px;
    transition: all 0.3s ease;
}

.summary-card:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.12);
    transform: translateY(-2px);
}

.summary-icon {
    font-size: 2rem;
    margin-bottom: 8px;
    line-height: 1;
    color: var(--accent-orange);
}

.summary-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 8px 0;
}

.summary-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    line-height: 1.2;
}

.summary-unit {
    display: block;
    font-size: 0.75rem;
    font-weight: 400;
    color: var(--text-secondary);
    margin-top: 2px;
}

.summary-period {
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-align: center;
    margin-top: 4px;
}

/* Formulário moderno */
.measurements-form {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 20px;
    padding: 24px;
    backdrop-filter: blur(10px);
}

.form-section {
    margin-bottom: 24px;
}

.form-section:last-child {
    margin-bottom: 0;
}

.section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 16px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Upload de fotos */
.photos-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
}

.photo-upload {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    border: 2px dashed rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 20px 12px;
    min-height: 120px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.photo-upload:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 107, 0, 0.5);
}

.photo-upload.has-image {
    border-style: solid;
    border-color: rgba(255, 107, 0, 0.3);
}

.photo-upload input[type="file"] {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
}

.upload-content {
    text-align: center;
    cursor: pointer;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.upload-icon {
    font-size: 1.5rem;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.section-title i {
    color: var(--accent-orange);
    margin-right: 8px;
}

.upload-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.upload-hint {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

/* Pré-visualização de fotos */
.photo-preview {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    border-radius: 8px;
    overflow: hidden;
}

.photo-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
}

.photo-preview .upload-icon,
.photo-preview .upload-label,
.photo-preview .upload-hint {
    position: relative;
    z-index: 2;
    background: transparent;
    padding: 0;
    border-radius: 0;
    backdrop-filter: none;
}

/* Quando há imagem, os textos ficam sobrepostos */
.photo-preview:has(img) .upload-icon,
.photo-preview:has(img) .upload-label,
.photo-preview:has(img) .upload-hint {
    position: absolute;
    background: rgba(0, 0, 0, 0.7);
    padding: 4px 8px;
    border-radius: 4px;
    backdrop-filter: blur(5px);
}

/* Posicionamento quando há imagem */
.photo-preview:has(img) .upload-icon {
    top: 8px;
    right: 8px;
    font-size: 1.2rem;
    color: white;
    margin: 0;
    padding: 6px;
}

.photo-preview:has(img) .upload-label {
    bottom: 8px;
    left: 8px;
    color: white;
    font-size: 0.8rem;
    margin: 0;
    padding: 4px 8px;
}

.photo-preview:has(img) .upload-hint {
    bottom: 8px;
    right: 8px;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.7rem;
    margin: 0;
    padding: 2px 6px;
}

/* Estilos normais para slots vazios */
.photo-preview .upload-icon {
    font-size: 1.5rem;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.photo-preview .upload-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.photo-preview .upload-hint {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

/* Controles de enquadramento */
.photo-crop-controls {
    position: absolute;
    bottom: 35px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 3;
}

.remove-icon-btn {
    width: 36px;
    height: 36px;
    background: rgba(0, 0, 0, 0.6);
    border: none;
    border-radius: 50%;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}

.photo-upload:hover .remove-icon-btn {
    opacity: 1;
}

.remove-icon-btn:hover {
    background: rgba(220, 53, 69, 0.9);
    color: white;
    transform: scale(1.1);
}

.remove-icon-btn i {
    font-size: 0.9rem;
}

/* Grid de medidas */
.measurements-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-primary);
}

.form-control {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    padding: 12px 16px;
    color: var(--text-primary);
    font-size: 0.9rem;
    transition: all 0.3s ease;
    width: 100%;
    box-sizing: border-box;
    max-width: 100%;
    min-width: 0;
    overflow: hidden;
}

input[type="date"].form-control {
    width: 100%;
    max-width: 100%;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    border-radius: 12px;
}

.form-group .form-control[type="date"] {
    border-radius: 12px;
    overflow: hidden;
}

.form-control:focus {
    outline: none;
    border-color: rgba(255, 107, 0, 0.5);
    background: rgba(255, 255, 255, 0.08);
}

.form-control::placeholder {
    color: var(--text-secondary);
}

/* Botão de ação */
.form-actions {
    margin-top: 24px;
    text-align: center;
}

.btn-primary {
    background: linear-gradient(135deg, #FF6B00 0%, #FF8533 100%);
    border: none;
    border-radius: 12px;
    padding: 14px 32px;
    color: white;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(255, 107, 0, 0.3);
}

.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Histórico de medidas */
.history-grid {
    display: grid;
    gap: 16px;
}

.history-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    padding: 20px;
    transition: all 0.3s ease;
}

.history-card:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.12);
}

.history-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
}

.history-date {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
}

.history-content {
    display: grid;
    gap: 16px;
}

.history-photos {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 12px;
}

.history-photo {
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.history-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.history-measurements {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
}

.measurement-item {
    text-align: center;
    padding: 8px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

.measurement-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

.measurement-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
}

/* Estado vazio */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    color: var(--text-secondary);
}

/* Nova Galeria Funcional */
.gallery-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.session-group {
    background: var(--card-bg, rgba(255, 255, 255, 0.03));
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border-color, rgba(255, 255, 255, 0.08));
}

.session-header {
    background: var(--primary-bg, rgba(255, 255, 255, 0.05));
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color, rgba(255, 255, 255, 0.08));
}

.session-header h4 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.session-card {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color, rgba(255, 255, 255, 0.08));
}

.session-card:last-child {
    border-bottom: none;
}

.session-info {
    display: flex;
    gap: 15px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}

.session-time, .session-weight {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.9rem;
    color: var(--text-secondary);
    background: rgba(255, 255, 255, 0.05);
    padding: 6px 10px;
    border-radius: 6px;
}

.session-photos {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
}

.photo-item-container {
    position: relative;
    aspect-ratio: 1;
    border-radius: 8px;
    overflow: hidden;
}

.photo-item {
    width: 100%;
    height: 100%;
    position: relative;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.photo-item:hover {
    transform: scale(1.02);
}

.photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

.photo-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
    padding: 8px;
}

.photo-type {
    color: white;
    font-size: 0.8rem;
    font-weight: 500;
}

.photo-item-container .delete-photo-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 20px;
    height: 20px;
    font-size: 0.6rem;
    z-index: 10;
}

/* Alert Messages */
.alert {
    padding: 12px;
    margin: 10px 0;
    border-radius: 8px;
    text-align: center;
}

.alert-success {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.3);
    color: #28a745;
}

.alert-error {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.3);
    color: #dc3545;
}

/* Loading State */
#loading-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
}

/* Responsividade */
@media (max-width: 768px) {
    .measurements-page-grid {
        padding: 20px 6px 15px 6px;
    }
    
    .page-header h1 {
        font-size: 1.7rem;
    }
    
    .current-summary {
        gap: 12px;
    }
    
    .summary-card {
        padding: 16px 12px;
        min-height: 100px;
    }
    
    .summary-icon {
        font-size: 1.8rem;
        margin-bottom: 6px;
    }
    
    .summary-label {
        font-size: 0.85rem;
    }
    
    .summary-value {
        font-size: 1rem;
    }
    
    .measurements-form {
        padding: 20px;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }
    
    .form-control {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        box-sizing: border-box !important;
    }
    
    input[type="date"].form-control,
    input[type="date"] {
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
        border-radius: 12px !important;
    }
    
    .form-group .form-control[type="date"] {
        border-radius: 12px !important;
        overflow: hidden !important;
    }
    
    .form-group {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }
    
    .photos-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .photo-upload {
        min-height: 100px;
        padding: 16px 12px;
    }
    
    .remove-icon-btn {
        width: 32px;
        height: 32px;
        font-size: 0.8rem;
    }
    
    .remove-icon-btn i {
        font-size: 0.8rem;
    }
    
    .measurements-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .history-measurements {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    
    .session-photos {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }
    
    .session-info {
        gap: 10px;
    }
    
    .session-time, .session-weight {
        font-size: 0.8rem;
        padding: 4px 8px;
    }
}

/* Date Input Wrapper */
.date-input-wrapper {
    position: relative;
    display: block;
    width: 100%;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    overflow: hidden;
}

.date-input-wrapper .form-control[type="date"] {
    border: none;
    background: transparent;
    box-shadow: none;
    padding: 12px 16px;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
}

.date-input-wrapper:has(.form-control[type="date"]:focus),
.date-input-wrapper:focus-within {
    border-color: rgba(255, 107, 0, 0.5);
    background: rgba(255, 255, 255, 0.08);
}

@media (max-width: 768px) {
    .date-input-wrapper {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }
    
    .date-input-wrapper .form-control[type="date"] {
        width: 100%;
        max-width: 100%;
        min-width: 0;
    }
}

/* Modal de Fotos */
.photo-modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

.photo-modal-content {
    position: relative;
    width: 100%;
    height: 100%;
    background: transparent;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    margin: 0;
    border-radius: 0;
    box-shadow: none;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
}

.photo-modal-header {
    position: absolute;
    top: env(safe-area-inset-top);
    left: env(safe-area-inset-left);
    right: env(safe-area-inset-right);
    z-index: 10;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    background: transparent;
    border-bottom: none;
}

.photo-modal-title h3 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1.2rem;
    font-weight: 600;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
}

.photo-modal-date {
    color: var(--text-secondary);
    font-size: 0.85rem;
    display: block;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
}

.photo-modal-footer {
    position: absolute;
    bottom: env(safe-area-inset-bottom);
    left: env(safe-area-inset-left);
    right: env(safe-area-inset-right);
    z-index: 10;
    padding: 20px;
    background: transparent;
    border-top: none;
}

.photo-modal-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.delete-photo-btn-modal {
    background: rgba(220, 53, 69, 0.8);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 10px 16px;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    font-weight: 600;
    backdrop-filter: blur(10px);
}

.delete-photo-btn-modal:hover {
    background: rgba(220, 53, 69, 1);
    transform: scale(1.05);
}

.photo-modal-close {
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.3);
    font-size: 1.1rem;
    color: var(--text-primary);
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.photo-modal-close:hover {
    background: rgba(0, 0, 0, 0.7);
    transform: scale(1.1);
}

.photo-modal-body {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    width: 100%;
    background: transparent;
}

.photo-viewer {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    background: transparent;
}

.photo-nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: var(--text-primary);
    width: 44px;
    height: 44px;
    border-radius: 50%;
    font-size: 1rem;
    cursor: pointer;
    z-index: 10;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.photo-nav-btn:hover {
    background: rgba(0, 0, 0, 0.7);
    transform: translateY(-50%) scale(1.1);
}

.photo-prev {
    left: 15px;
}

.photo-next {
    right: 15px;
}

.photo-container {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
}

.photo-container img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 0;
}

.photo-counter {
    background: rgba(0, 0, 0, 0.5);
    color: var(--text-secondary);
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    backdrop-filter: blur(10px);
}

html, body {
    background-color: #1C1C1E;
}

* {
    -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
}

.photo-upload {
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
}
    </style>
</head>
<body>
    <div class="fixed-background"></div>
    <div id="alert-container"></div>
    
    <div class="app-container">
        <section class="measurements-page-grid">
            <!-- Header da página -->
            <header class="page-header">
    <script src="./www-config.js"></script>
                <a href="./progress.html" class="back-button">
                    <i class="fas fa-chevron-left"></i>
                </a>
                <h1>Fotos e Medidas</h1>
            </header>
            
            <div id="alert-messages"></div>

            <!-- Formulário para novos registros -->
            <form id="measurements-form" class="measurements-form">
                <!-- Data do Registro -->
                <div class="form-section">
                    <div class="form-group">
                        <label for="date_recorded"><i class="fas fa-calendar-alt"></i> Data do Registro</label>
                        <div class="date-input-wrapper">
                            <input type="date" id="date_recorded" name="date_recorded" class="form-control">
                        </div>
                        <div style="margin-top: 6px; font-size: 0.8rem; color: var(--text-secondary);">
                            <i class="fas fa-info-circle"></i> Não é possível registrar fotos com data futura.
                        </div>
                    </div>
                </div>

                <!-- Fotos de Progresso -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-camera"></i> Fotos de Progresso</h3>
                    <div class="photos-grid">
                        <div class="photo-upload">
                            <input type="file" name="photo_front" id="photo_front" accept="image/*">
                            <label for="photo_front" class="upload-content">
                                <div class="photo-preview" id="frontPreview">
                                    <div class="upload-icon"><i class="fas fa-camera"></i></div>
                                    <div class="upload-label">Frente</div>
                                    <div class="upload-hint">Toque para adicionar</div>
                                </div>
                            </label>
                            <div class="photo-crop-controls" id="frontCropControls" style="display: none;">
                                <button type="button" class="remove-icon-btn" onclick="removePhoto('front')" title="Remover foto">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="photo-upload">
                            <input type="file" name="photo_side" id="photo_side" accept="image/*">
                            <label for="photo_side" class="upload-content">
                                <div class="photo-preview" id="sidePreview">
                                    <div class="upload-icon"><i class="fas fa-camera"></i></div>
                                    <div class="upload-label">Lado</div>
                                    <div class="upload-hint">Toque para adicionar</div>
                                </div>
                            </label>
                            <div class="photo-crop-controls" id="sideCropControls" style="display: none;">
                                <button type="button" class="remove-icon-btn" onclick="removePhoto('side')" title="Remover foto">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="photo-upload">
                            <input type="file" name="photo_back" id="photo_back" accept="image/*">
                            <label for="photo_back" class="upload-content">
                                <div class="photo-preview" id="backPreview">
                                    <div class="upload-icon"><i class="fas fa-camera"></i></div>
                                    <div class="upload-label">Costas</div>
                                    <div class="upload-hint">Toque para adicionar</div>
                                </div>
                            </label>
                            <div class="photo-crop-controls" id="backCropControls" style="display: none;">
                                <button type="button" class="remove-icon-btn" onclick="removePhoto('back')" title="Remover foto">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Medidas Corporais -->
                <div class="form-section">
                    <h3 class="section-title"><i class="fas fa-ruler"></i> Medidas Corporais</h3>
                    <div class="measurements-grid">
                        <div class="form-group">
                            <label for="weight_kg"><i class="fas fa-weight"></i> Peso (kg)</label>
                            <input type="number" id="weight_kg" name="weight_kg" class="form-control" step="0.1" min="0" readonly style="background: rgba(255, 255, 255, 0.03); border-color: rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.6); cursor: not-allowed;">
                            <div style="margin-top: 6px; font-size: 0.8rem; color: var(--text-secondary);">
                                <i class="fas fa-info-circle"></i> O peso é automaticamente puxado do seu perfil. Para alterar, edite seu perfil.
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="neck">Pescoço (cm)</label>
                            <input type="number" step="0.1" name="neck" id="neck" class="form-control" placeholder="Opcional">
                        </div>
                        <div class="form-group">
                            <label for="chest">Tórax (cm)</label>
                            <input type="number" step="0.1" name="chest" id="chest" class="form-control" placeholder="Opcional">
                        </div>
                        <div class="form-group">
                            <label for="waist">Cintura (cm)</label>
                            <input type="number" step="0.1" name="waist" id="waist" class="form-control" placeholder="Opcional">
                        </div>
                        <div class="form-group">
                            <label for="abdomen">Abdômen (cm)</label>
                            <input type="number" step="0.1" name="abdomen" id="abdomen" class="form-control" placeholder="Opcional">
                        </div>
                        <div class="form-group">
                            <label for="hips">Quadril (cm)</label>
                            <input type="number" step="0.1" name="hips" id="hips" class="form-control" placeholder="Opcional">
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary" id="submit-btn"><i class="fas fa-save"></i> Salvar Medidas e Fotos</button>
                </div>
            </form>

            <!-- Galeria de Fotos -->
            <div class="glass-card">
                <h3 class="section-title"><i class="fas fa-images"></i> Galeria de Fotos</h3>
                
                <div id="loading-state" style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 16px;"></i>
                    <p>Carregando galeria...</p>
                </div>
                
                <div id="empty-state" class="empty-state" style="display: none;">
                    <div style="font-size: 3rem; margin-bottom: 16px;"><i class="fas fa-camera"></i></div>
                    <h4 style="color: var(--text-primary); margin-bottom: 8px;">Nenhuma foto ainda</h4>
                    <p>Adicione suas fotos acima para começar a acompanhar seu progresso!</p>
                </div>
                
                <div id="gallery-container" class="gallery-container" style="display: none;"></div>
            </div>
        </section>
    </div>

    <!-- Bottom Navigation -->
    <script src="./assets/js/bottom-nav.js"></script>
    
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // Verificar autenticação
        (async function() {
            const authenticated = await requireAuth();
            if (!authenticated) {
                return; // Já redirecionou para login
            }
            
            const BASE_URL = window.BASE_APP_URL;
            let pageData = null;
            
            // Função para mostrar alertas
            function showAlert(message, type = 'success') {
                const alertContainer = document.getElementById('alert-messages');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${escapeHtml(message)}`;
                alertContainer.appendChild(alert);
                
                setTimeout(() => {
                    alert.remove();
                }, 5000);
            }
            
            // Verificar mensagens da URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success') === '1') {
                showAlert(urlParams.get('msg') || 'Operação realizada com sucesso!', 'success');
            }
            if (urlParams.get('error') === '1') {
                showAlert(urlParams.get('msg') || 'Erro ao processar a solicitação.', 'error');
            }
            
            // Carregar dados da página
            async function loadPageData() {
                try {
                    const apiUrl = `${BASE_URL}/api/get_measurements_data.php`;
                    const response = await authenticatedFetch(apiUrl);
                    
                    if (!response) return; // Token inválido, já redirecionou
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.message || 'Erro ao carregar dados');
                    }
                    
                    pageData = result.data;
                    
                    // Preencher peso do perfil
                    const weightInput = document.getElementById('weight_kg');
                    if (weightInput && pageData.user_profile && pageData.user_profile.weight_kg) {
                        weightInput.value = parseFloat(pageData.user_profile.weight_kg).toFixed(1);
                        weightInput.placeholder = parseFloat(pageData.user_profile.weight_kg).toFixed(1);
                    }
                    
                    // Definir data padrão (hoje)
                    const dateInput = document.getElementById('date_recorded');
                    if (dateInput) {
                        const today = new Date();
                        const year = today.getFullYear();
                        const month = String(today.getMonth() + 1).padStart(2, '0');
                        const day = String(today.getDate()).padStart(2, '0');
                        dateInput.value = `${year}-${month}-${day}`;
                        dateInput.setAttribute('max', `${year}-${month}-${day}`);
                    }
                    
                    // Renderizar galeria
                    renderGallery();
                    
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    document.getElementById('loading-state').innerHTML = `
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px; color: var(--accent-orange);"></i>
                        <p>Erro ao carregar dados. Tente novamente.</p>
                    `;
                }
            }
            
            function renderGallery() {
                document.getElementById('loading-state').style.display = 'none';
                
                if (!pageData.history || pageData.history.length === 0) {
                    document.getElementById('empty-state').style.display = 'block';
                    document.getElementById('gallery-container').style.display = 'none';
                    return;
                }
                
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('gallery-container').style.display = 'flex';
                
                // Agrupar por data e sessão
                const groupedSessions = {};
                pageData.history.forEach(record => {
                    const dateKey = record.date_recorded;
                    const timeKey = record.created_at ? new Date(record.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
                    
                    if (!groupedSessions[dateKey]) {
                        groupedSessions[dateKey] = {};
                    }
                    
                    if (!groupedSessions[dateKey][timeKey]) {
                        groupedSessions[dateKey][timeKey] = {
                            date: record.date_recorded,
                            time: timeKey,
                            weight: record.weight_kg,
                            photos: [],
                            measurements: []
                        };
                    }
                    
                    // Adicionar fotos
                    const photoTypes = [
                        { key: 'photo_front', label: 'Frente' },
                        { key: 'photo_side', label: 'Lado' },
                        { key: 'photo_back', label: 'Costas' }
                    ];
                    
                    photoTypes.forEach(({ key, label }) => {
                        if (record[key]) {
                            groupedSessions[dateKey][timeKey].photos.push({
                                id: record.id,
                                type: key,
                                label: label,
                                filename: record[key]
                            });
                        }
                    });
                });
                
                // Renderizar HTML
                let html = '';
                Object.keys(groupedSessions).sort().reverse().forEach(dateKey => {
                    const sessions = groupedSessions[dateKey];
                    const sessionsWithPhotos = Object.values(sessions).filter(session => session.photos.length > 0);
                    
                    if (sessionsWithPhotos.length === 0) return;
                    
                    const dateDisplay = new Date(dateKey).toLocaleDateString('pt-BR');
                    html += `
                        <div class="session-group">
                            <div class="session-header">
                                <h4><i class="fas fa-calendar-day"></i> ${dateDisplay}</h4>
                            </div>
                    `;
                    
                    Object.values(sessionsWithPhotos).forEach(session => {
                        html += `
                            <div class="session-card">
                                <div class="session-info">
                                    <span class="session-time">
                                        <i class="fas fa-clock"></i> ${session.time}
                                    </span>
                                    ${session.weight ? `
                                        <span class="session-weight">
                                            <i class="fas fa-weight"></i> ${parseFloat(session.weight).toFixed(1)} kg
                                        </span>
                                    ` : ''}
                                </div>
                                <div class="session-photos">
                        `;
                        
                        session.photos.forEach(photo => {
                            const photoUrl = `${pageData.base_url}/uploads/measurements/${escapeHtml(photo.filename)}`;
                            html += `
                                <div class="photo-item-container">
                                    <div class="photo-item" onclick="openPhotoModal('${photoUrl}', '${photo.label}', '${dateDisplay} ${session.time}', ${photo.id}, '${photo.type}')">
                                        <img src="${photoUrl}" alt="${photo.label}" onerror="this.style.display='none'">
                                        <div class="photo-overlay">
                                            <span class="photo-type">${photo.label}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                });
                
                document.getElementById('gallery-container').innerHTML = html;
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Função helper para obter data local
            function getLocalDateString() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // Função para inicializar preview de fotos
            function setupPhotoPreview() {
                const photoInputs = document.querySelectorAll('input[type="file"]');
                
                photoInputs.forEach(input => {
                    // Não remover listeners - apenas adicionar se não existir
                    if (input.dataset.listenerAdded) {
                        return; // Já tem listener
                    }
                    input.dataset.listenerAdded = 'true';
                    
                    input.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            console.log('Arquivo selecionado:', file.name);
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const photoType = input.id.replace('photo_', '');
                                const preview = document.getElementById(photoType + 'Preview');
                                console.log('Preview element:', preview, 'Photo type:', photoType);
                                
                                if (preview) {
                                    preview.innerHTML = '';
                                    
                                    const img = document.createElement('img');
                                    img.src = e.target.result;
                                    img.style.width = '100%';
                                    img.style.height = '100%';
                                    img.style.objectFit = 'cover';
                                    img.style.borderRadius = '8px';
                                    
                                    const overlay = document.createElement('div');
                                    overlay.style.position = 'absolute';
                                    overlay.style.top = '0';
                                    overlay.style.left = '0';
                                    overlay.style.right = '0';
                                    overlay.style.bottom = '0';
                                    overlay.style.background = 'rgba(0, 0, 0, 0.3)';
                                    overlay.style.borderRadius = '8px';
                                    overlay.style.display = 'flex';
                                    overlay.style.flexDirection = 'column';
                                    overlay.style.alignItems = 'center';
                                    overlay.style.justifyContent = 'center';
                                    overlay.style.color = 'white';
                                    
                                    const label = document.createElement('div');
                                    const labelText = photoType === 'front' ? 'Frente' : 
                                                    photoType === 'side' ? 'Lado' : 
                                                    photoType === 'back' ? 'Costas' : photoType;
                                    label.textContent = labelText;
                                    label.style.fontWeight = '600';
                                    label.style.fontSize = '0.9rem';
                                    label.style.marginBottom = '4px';
                                    
                                    const hint = document.createElement('div');
                                    hint.textContent = 'Toque para alterar';
                                    hint.style.fontSize = '0.75rem';
                                    hint.style.opacity = '0.8';
                                    
                                    overlay.appendChild(label);
                                    overlay.appendChild(hint);
                                    
                                    preview.appendChild(img);
                                    preview.appendChild(overlay);
                                    
                                    const controls = document.getElementById(photoType + 'CropControls');
                                    if (controls) {
                                        controls.style.display = 'flex';
                                    }
                                    
                                    console.log('Preview atualizado com sucesso');
                                } else {
                                    console.error('Elemento preview não encontrado:', photoType + 'Preview');
                                }
                            };
                            reader.onerror = function(error) {
                                console.error('Erro ao ler arquivo:', error);
                                showAlert('Erro ao carregar a imagem. Tente novamente.', 'error');
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                });
            }
            
            // Inicializar quando DOM estiver pronto
            function initializeForm() {
                const form = document.getElementById('measurements-form');
                const submitBtn = document.getElementById('submit-btn');
                const dateInput = document.getElementById('date_recorded');
                
                // Validar data futura
                if (dateInput) {
                    const today = getLocalDateString();
                    dateInput.setAttribute('max', today);
                    
                    dateInput.addEventListener('change', function() {
                        const selectedDate = new Date(this.value);
                        const todayDate = new Date();
                        todayDate.setHours(0, 0, 0, 0);
                        
                        if (selectedDate > todayDate) {
                            showAlert('Não é possível registrar fotos com data futura. Por favor, selecione uma data válida.', 'error');
                            this.value = today;
                        }
                    });
                }
                
                // Validar envio de formulário
                if (form) {
                    form.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        
                        // Verificar se pelo menos uma foto foi enviada
                        const photoInputs = ['photo_front', 'photo_side', 'photo_back'];
                        let hasPhoto = false;
                        let photoCount = 0;
                        
                        photoInputs.forEach(inputId => {
                            const input = document.getElementById(inputId);
                            console.log('Verificando input:', inputId, input);
                            if (input) {
                                console.log('Input files:', input.files, 'Length:', input.files ? input.files.length : 0);
                                if (input.files && input.files.length > 0) {
                                    // Verificar se o arquivo tem tamanho maior que 0
                                    const file = input.files[0];
                                    if (file && file.size > 0) {
                                        hasPhoto = true;
                                        photoCount++;
                                        console.log('Foto encontrada em:', inputId, 'Tamanho:', file.size, 'bytes');
                                    } else {
                                        console.log('Arquivo vazio ignorado em:', inputId);
                                    }
                                }
                            }
                        });
                        
                        console.log('Total de fotos encontradas:', photoCount, 'hasPhoto:', hasPhoto);
                        
                        if (!hasPhoto) {
                            console.error('ERRO: Nenhuma foto válida encontrada!');
                            showAlert('Por favor, envie pelo menos uma foto antes de salvar.', 'error');
                            return false;
                        }
                        
                        console.log('Validação de foto passou! Prosseguindo com validação de data...');
                        
                        // Validar data (verificação dupla)
                        if (dateInput) {
                            const selectedDate = new Date(dateInput.value);
                            const todayDate = new Date();
                            todayDate.setHours(0, 0, 0, 0);
                            
                            console.log('Data selecionada:', selectedDate, 'Data de hoje:', todayDate);
                            
                            if (selectedDate > todayDate) {
                                console.error('ERRO: Data futura detectada!');
                                showAlert('Não é possível registrar fotos com data futura. Por favor, selecione uma data válida.', 'error');
                                dateInput.value = getLocalDateString();
                                return false;
                            }
                            console.log('Validação de data passou!');
                        }
                        
                        console.log('Todas as validações passaram! Enviando para servidor...');
                        
                        // Desabilitar botão
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
                        
                        try {
                            // Criar FormData
                            const originalFormData = new FormData(form);
                            
                            // Remover arquivos vazios (0 bytes) do FormData
                            const cleanFormData = new FormData();
                            for (let pair of originalFormData.entries()) {
                                if (pair[1] instanceof File) {
                                    if (pair[1].size > 0) {
                                        cleanFormData.append(pair[0], pair[1]);
                                        console.log('Arquivo válido adicionado:', pair[0], pair[1].name, pair[1].size, 'bytes');
                                    } else {
                                        console.log('Arquivo vazio ignorado:', pair[0]);
                                    }
                                } else {
                                    cleanFormData.append(pair[0], pair[1]);
                                }
                            }
                            
                            // Debug: verificar o que está no FormData limpo
                            console.log('FormData limpo. Verificando arquivos:');
                            for (let pair of cleanFormData.entries()) {
                                if (pair[1] instanceof File) {
                                    console.log('Arquivo encontrado:', pair[0], pair[1].name, pair[1].size, 'bytes');
                                } else {
                                    console.log('Campo:', pair[0], pair[1]);
                                }
                            }
                            
                            // Usar FormData limpo
                            const formData = cleanFormData;
                            
                            // Verificar se há arquivos no FormData antes de enviar
                            let hasFilesInFormData = false;
                            for (let pair of formData.entries()) {
                                if (pair[1] instanceof File && pair[1].size > 0) {
                                    hasFilesInFormData = true;
                                    console.log('Arquivo confirmado no FormData antes de enviar:', pair[0], pair[1].name, pair[1].size, 'bytes');
                                }
                            }
                            
                            if (!hasFilesInFormData) {
                                console.error('ERRO: Nenhum arquivo válido no FormData antes de enviar!');
                                showAlert('Erro: Nenhuma foto válida foi preparada para envio.', 'error');
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Medidas e Fotos';
                                return;
                            }
                            
                            console.log('Enviando FormData para servidor...');
                            console.log('FormData é instância de FormData?', formData instanceof FormData);
                            console.log('Tipo do formData:', typeof formData, formData.constructor.name);
                            
                            // Obter token para Authorization
                            const token = getAuthToken();
                            
                            // Criar headers manualmente - apenas Authorization, SEM Content-Type
                            const headers = {};
                            if (token) {
                                headers['Authorization'] = `Bearer ${token}`;
                            }
                            
                            console.log('Headers que serão enviados:', headers);
                            
                            // IMPORTANTE: Não adicionar data do cliente ao FormData
                            // O servidor deve usar sua própria data/hora para validar restrições (ex: 7 dias para peso)
                            // Isso previne que usuários burlem mudando a data do celular
                            
                            // Enviar usando fetch direto para garantir que FormData funcione corretamente
                            const response = await fetch(`${BASE_URL}/api/save_measurements.php`, {
                                method: 'POST',
                                body: formData,
                                headers: headers // Apenas Authorization - browser vai adicionar Content-Type automaticamente
                                // NÃO enviar data - servidor usa sua própria data/hora para validação
                            });
                            
                            console.log('Resposta recebida do servidor. Status:', response.status);
                            
                            // Verificar se recebeu 401 (não autorizado)
                            if (response.status === 401) {
                                console.error('Token inválido (401) - redirecionando para login');
                                if (typeof clearAuthToken === 'function') {
                                    clearAuthToken();
                                }
                                const targetUrl = './auth/login.html';
                                window.location.href = targetUrl;
                                return;
                            }
                            
                            const result = await response.json();
                            console.log('Resultado do servidor:', result);
                            
                            if (result.success) {
                                console.log('Sucesso! Medidas salvas.');
                                showAlert(result.message || 'Medidas salvas com sucesso!', 'success');
                                
                                // Limpar formulário
                                form.reset();
                                
                                // Restaurar previews
                                ['front', 'side', 'back'].forEach(type => {
                                    removePhoto(type);
                                });
                                
                                // Recarregar dados
                                await loadPageData();
                                
                                // Reconfigurar preview após reset
                                setupPhotoPreview();
                            } else {
                                console.error('ERRO do servidor:', result.message);
                                showAlert(result.message || 'Erro ao salvar medidas.', 'error');
                            }
                        } catch (error) {
                            console.error('Erro ao salvar:', error);
                            console.error('Stack trace:', error.stack);
                            showAlert('Erro ao salvar medidas. Tente novamente.', 'error');
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Medidas e Fotos';
                        }
                    });
                }
                
                // Configurar preview de fotos
                setupPhotoPreview();
            }
            
            // Função para remover foto
            window.removePhoto = function(photoType) {
                const input = document.getElementById('photo_' + photoType);
                const preview = document.getElementById(photoType + 'Preview');
                const controls = document.getElementById(photoType + 'CropControls');
                
                if (input) input.value = '';
                
                const labelText = photoType === 'front' ? 'Frente' : 
                                 photoType === 'side' ? 'Lado' : 
                                 photoType === 'back' ? 'Costas' : photoType;
                
                if (preview) {
                    preview.innerHTML = `
                        <div class="upload-icon"><i class="fas fa-camera"></i></div>
                        <div class="upload-label">${labelText}</div>
                        <div class="upload-hint">Toque para adicionar</div>
                    `;
                }
                
                if (controls) {
                    controls.style.display = 'none';
                }
            };
            
            // Função para abrir modal de foto
            window.openPhotoModal = function(imageSrc, label, date, photoId = null, photoType = null) {
                const allPhotos = [];
                document.querySelectorAll('.photo-item img').forEach((img, index) => {
                    if (img.src && !img.src.includes('data:image')) {
                        const photoItem = img.closest('.photo-item');
                        const onclick = photoItem.getAttribute('onclick');
                        if (onclick) {
                            const match = onclick.match(/openPhotoModal\('([^']+)',\s*'([^']+)',\s*'([^']+)',\s*(\d+),\s*'([^']+)'\)/);
                            if (match) {
                                allPhotos.push({
                                    src: match[1],
                                    label: match[2],
                                    date: match[3],
                                    id: match[4],
                                    type: match[5]
                                });
                            }
                        }
                    }
                });
                
                let currentIndex = allPhotos.findIndex(photo => photo.src === imageSrc);
                if (currentIndex === -1) currentIndex = 0;
                
                const modal = document.createElement('div');
                modal.id = 'photoModal';
                modal.className = 'photo-modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="photo-modal-content">
                        <div class="photo-modal-header">
                            <div class="photo-modal-title">
                                <h3>${escapeHtml(label)}</h3>
                                <span class="photo-modal-date">${escapeHtml(date)}</span>
                            </div>
                            <div class="photo-modal-actions">
                                <button class="photo-modal-close" onclick="closePhotoModal()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="photo-modal-body">
                            <div class="photo-viewer">
                                ${allPhotos.length > 1 ? `<button class="photo-nav-btn photo-prev" onclick="navigatePhoto(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>` : ''}
                                <div class="photo-container">
                                    <img id="modalPhoto" src="${escapeHtml(imageSrc)}" alt="${escapeHtml(label)}">
                                </div>
                                ${allPhotos.length > 1 ? `<button class="photo-nav-btn photo-next" onclick="navigatePhoto(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>` : ''}
                            </div>
                        </div>
                        <div class="photo-modal-footer">
                            <div class="photo-modal-info">
                                ${allPhotos.length > 1 ? `<div class="photo-counter">
                                    <span id="photoCounter">${currentIndex + 1} / ${allPhotos.length}</span>
                                </div>` : ''}
                                ${photoId ? `<button class="delete-photo-btn-modal" onclick="deletePhoto(${photoId}, '${photoType}')" title="Excluir foto">
                                    <i class="fas fa-trash-alt"></i>
                                    <span>Excluir</span>
                                </button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                modal.allPhotos = allPhotos;
                modal.currentIndex = currentIndex;
                
                document.body.appendChild(modal);
                document.body.style.overflow = 'hidden';
            };
            
            // Função para navegar entre fotos
            window.navigatePhoto = function(direction) {
                const modal = document.getElementById('photoModal');
                if (!modal || !modal.allPhotos) return;
                
                modal.currentIndex += direction;
                
                if (modal.currentIndex >= modal.allPhotos.length) {
                    modal.currentIndex = 0;
                } else if (modal.currentIndex < 0) {
                    modal.currentIndex = modal.allPhotos.length - 1;
                }
                
                const photo = modal.allPhotos[modal.currentIndex];
                const img = document.getElementById('modalPhoto');
                const counter = document.getElementById('photoCounter');
                const title = modal.querySelector('.photo-modal-title h3');
                const date = modal.querySelector('.photo-modal-date');
                const deleteBtn = modal.querySelector('.delete-photo-btn-modal');
                
                if (img) img.src = photo.src;
                if (counter) counter.textContent = `${modal.currentIndex + 1} / ${modal.allPhotos.length}`;
                if (title) title.textContent = photo.label;
                if (date) date.textContent = photo.date;
                
                if (deleteBtn) {
                    deleteBtn.setAttribute('onclick', `deletePhoto(${photo.id}, '${photo.type}')`);
                }
            };
            
            // Função para fechar modal
            window.closePhotoModal = function() {
                const modal = document.getElementById('photoModal');
                if (modal) {
                    modal.remove();
                    document.body.style.overflow = 'auto';
                }
            };
            
            // Função para deletar foto
            window.deletePhoto = async function(measurementId, photoType) {
                if (!confirm('Tem certeza que deseja remover esta foto?')) {
                    return;
                }
                
                try {
                    const response = await authenticatedFetch(`${BASE_URL}/api/delete_measurement_photo.php`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            measurement_id: measurementId,
                            photo_type: photoType
                        })
                    });
                    
                    if (!response) return;
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showAlert(result.message || 'Foto removida com sucesso!', 'success');
                        closePhotoModal();
                        await loadPageData();
                    } else {
                        showAlert(result.message || 'Erro ao remover foto.', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao deletar foto:', error);
                    showAlert('Erro ao remover foto. Tente novamente.', 'error');
                }
            };
            
            // Fechar modal com ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePhotoModal();
                }
            });
            
            // Fechar modal clicando fora
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('photo-modal')) {
                    closePhotoModal();
                }
            });
            
            // Aguardar DOM estar pronto antes de inicializar
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    // Inicializar formulário imediatamente
                    initializeForm();
                    // Carregar dados
                    loadPageData();
                });
            } else {
                // DOM já está pronto
                initializeForm();
                // Carregar dados
                loadPageData();
            }
        })();
    </script>
</body>
</html>
